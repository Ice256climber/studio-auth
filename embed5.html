<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å­¦ç¿’å®Ÿæ…‹èª¿æŸ»</title>
<style>
:root{ --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#4461f2; --radius:12px; }
*{box-sizing:border-box}
body{font-family:Inter,system-ui,'Noto Sans JP',sans-serif;background:var(--bg);margin:18px;color:#0f1724}
.wrap{max-width:1100px;margin:0 auto}
.card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 10px 30px rgba(16,24,40,0.06)}
.top{display:flex;gap:12px;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.palette{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.subject-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;color:#fff;font-weight:700;cursor:pointer;border:0}
.grid-wrap{overflow:auto;margin-top:12px}
.hours-grid{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(72px,1fr);padding:12px}
.hour-col{min-width:72px;padding:6px}
.hour-header{font-size:12px;color:var(--muted);text-align:center;margin-bottom:6px}
.hour-cell{height:72px;border-radius:10px;border:1px solid rgba(16,24,40,0.04);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff,#fbfbff)}
.segments{display:flex;height:100%;width:100%}
.segment{flex:1;position:relative}
.fill{position:absolute;left:0;top:0;bottom:0;width:0;transition:width .2s linear}
.overlay{position:absolute;left:0;right:0;bottom:6px;text-align:center;font-weight:700;color:rgba(0,0,0,0.65);z-index:3}
.cell-label{position:absolute;left:6px;top:6px;font-weight:700;color:rgba(0,0,0,0.75);z-index:4}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
.legend .item{display:flex;align-items:center;gap:8px}
.legend input[type="color"]{border:0;padding:0;width:34px;height:28px;border-radius:6px}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(68,97,242,0.12)}
.add-subject{display:flex;gap:8px;margin-top:8px;align-items:center}
.auth-status{padding:10px;border-radius:8px;background:#f0f9ff;border:1px solid #bae6fd;font-size:13px}
.auth-status.logged-out{background:#fef2f2;border-color:#fecaca}
@media(max-width:900px){.hour-cell{height:56px}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ãƒ‡ã‚¸ã‚¿ãƒ«ç‰ˆå­¦ç¿’å®Ÿæ…‹èª¿æŸ»</h1>

  <div class="top">
    <!-- ã‚¿ã‚¤ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ -->
    <div class="card" style="min-width:480px">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div><div class="small">æ—¥ä»˜</div><input type="date" id="dateInput"></div>
        <div><div class="small">é–‹å§‹æ™‚åˆ»</div><input type="time" id="startTimeInput"></div>
        <div style="margin-left:8px"><div class="small">æ“ä½œ</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="startBtn" class="btn">é–‹å§‹</button>
            <button id="resetBtn" class="btn ghost">ãƒªã‚»ãƒƒãƒˆ</button>
            <button id="setNowBtn" class="btn ghost">ä»Šã«</button>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:16px;margin-top:10px;align-items:center">
        <div class="small">çµŒéï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰<div id="elapsedLabel" style="font-weight:800">00:00:00</div></div>
        <div class="small">ä»Šæ—¥åˆè¨ˆ<div id="todayTotalLabel" style="font-weight:800">0:00:00</div></div>
      </div>
    </div>

    <!-- èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="card" style="min-width:280px">
      <div class="small" style="margin-bottom:8px">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
      <div id="authStatus" class="auth-status logged-out">
        æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
      </div>
    </div>

    <!-- æ•™ç§‘é¸æŠã‚«ãƒ¼ãƒ‰ -->
    <div class="card" style="min-width:360px">
      <div class="small">æ•™ç§‘ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆé¸æŠã—ã¦ã‹ã‚‰é–‹å§‹ï¼‰</div>
      <div id="palette" class="palette"></div>
      <div id="legend" class="legend"></div>

      <div class="add-subject">
        <input id="newSubjectName" placeholder="æ–°ã—ã„æ•™ç§‘å" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb;flex:1" />
        <input id="newSubjectColor" type="color" value="#7c3aed" />
        <button id="addSubjectBtn" class="btn">è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- ã‚°ãƒªãƒƒãƒ‰ -->
  <div class="card">
    <div class="small">æ™‚é–“è¡¨ç¤ºã¨å¡—ã‚Š</div>
    <div class="grid-wrap"><div id="hoursGrid" class="hours-grid"></div></div>
  </div>
</div>

<script type="module">
/* ==========================================
   Supabase Setup
   ========================================== */
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
window.supabase = supabase

/* ==========================================
   Constants & State
   ========================================== */
const SEG_MIN = 5, SEG_MS = SEG_MIN * 60000, SEG_H = 60 / SEG_MIN
const STORAGE = 'studio_v4'
let state = { 
  hourSegments: {}, 
  colors: {}, 
  timer: { running:false, sessionAccumulatedMs:0, _lastTick:null }
}
let SUBJECTS = [
  { key:'jp', name:'å›½èª', color:'#FF6B6B' },
  { key:'math', name:'æ•°å­¦', color:'#4D9FEE' },
  { key:'sci', name:'ç†ç§‘', color:'#47C88E' },
  { key:'soc', name:'ç¤¾ä¼š', color:'#F6C85F' },
  { key:'en', name:'è‹±èª', color:'#9B7BFF' },
]
let sel = SUBJECTS[0].key
let currentUser = null

/* ==========================================
   DOM References
   ========================================== */
const dateInput = document.getElementById('dateInput')
const startTimeInput = document.getElementById('startTimeInput')
const startBtn = document.getElementById('startBtn')
const resetBtn = document.getElementById('resetBtn')
const setNowBtn = document.getElementById('setNowBtn')
const hoursGrid = document.getElementById('hoursGrid')
const palette = document.getElementById('palette')
const legend = document.getElementById('legend')
const elapsedLabel = document.getElementById('elapsedLabel')
const todayTotalLabel = document.getElementById('todayTotalLabel')
const authStatus = document.getElementById('authStatus')
const addSubjectBtn = document.getElementById('addSubjectBtn')
const newSubjectName = document.getElementById('newSubjectName')
const newSubjectColor = document.getElementById('newSubjectColor')

/* ==========================================
   Helper Functions
   ========================================== */
const fmt = ms => {
  if(!ms) return '0:00:00'
  let s = Math.floor(ms/1000)
  let h = Math.floor(s/3600)
  s = s % 3600
  const m = Math.floor(s/60)
  const sec = s%60
  return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`
}

const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`

const todayY = () => ymd(new Date())

const timeIn = d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`

function ensureDay(dayStr){ 
  if(!state.hourSegments[dayStr]) {
    state.hourSegments[dayStr] = Array.from({length:24}, ()=> 
      Array.from({length:SEG_H}, ()=> ({subject:'', filledMs:0}))
    )
  }
}

function shade(hex, percent){ 
  const h = hex.replace('#','')
  const r = parseInt(h.substring(0,2),16)
  const g = parseInt(h.substring(2,4),16)
  const b = parseInt(h.substring(4,6),16)
  const t = percent < 0 ? 0 : 255
  const p = Math.abs(percent)/100
  const R = Math.round((t-r)*p)+r
  const G = Math.round((t-g)*p)+g
  const B = Math.round((t-b)*p)+b
  return `rgb(${R}, ${G}, ${B})`
}

/* ==========================================
   Local Storage
   ========================================== */
function loadLocal(){
  try{ 
    const raw = localStorage.getItem(STORAGE)
    if(raw){ 
      const parsed = JSON.parse(raw)
      state = Object.assign({}, state, parsed)
    }
  }catch(e){ 
    console.warn('loadLocal', e)
  }
  SUBJECTS.forEach(s => { 
    if(!state.colors[s.key]) state.colors[s.key] = s.color 
  })
}

function saveLocal(){ 
  try{ 
    localStorage.setItem(STORAGE, JSON.stringify(state))
  }catch(e){ 
    console.warn('saveLocal', e)
  }
}

/* ==========================================
   Auth Management
   ========================================== */
async function checkAuth(){
  try{
    const { data: { user }, error } = await supabase.auth.getUser()
    
    if(error) throw error
    
    if(user){
      currentUser = user
      authStatus.className = 'auth-status'
      authStatus.innerHTML = `âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}<br><small>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${user.id.slice(0,8)}...</small>`
      console.log('âœ… èªè¨¼ç¢ºèª: ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿', user.email)
    } else {
      currentUser = null
      authStatus.className = 'auth-status logged-out'
      authStatus.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'
      console.log('âš ï¸ èªè¨¼ç¢ºèª: æœªãƒ­ã‚°ã‚¤ãƒ³')
    }
  }catch(e){
    console.error('âŒ èªè¨¼ç¢ºèªã‚¨ãƒ©ãƒ¼:', e)
    currentUser = null
    authStatus.className = 'auth-status logged-out'
    authStatus.textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼'
  }
}

// èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
supabase.auth.onAuthStateChange((event, session) => {
  console.log('ğŸ”„ èªè¨¼çŠ¶æ…‹å¤‰æ›´:', event)
  checkAuth()
})

/* ==========================================
   Subject Palette
   ========================================== */
function buildPalette(){
  palette.innerHTML = ''
  legend.innerHTML = ''
  
  SUBJECTS.forEach((s) => {
    if(!state.colors[s.key]) state.colors[s.key] = s.color
    
    const btn = document.createElement('button')
    btn.className = 'subject-btn'
    btn.dataset.key = s.key
    btn.style.background = state.colors[s.key]
    btn.innerHTML = `<div style="width:14px;height:14px;border-radius:50%;background:${shade(state.colors[s.key],-8)}"></div><div>${s.name}</div>`
    btn.addEventListener('click', ()=>{ sel = s.key; highlightSelected() })
    palette.appendChild(btn)
    
    const item = document.createElement('div')
    item.className='item'
    item.style.display='flex'
    item.style.alignItems='center'
    item.style.gap='8px'
    
    const sw = document.createElement('div')
    sw.style.width='18px'
    sw.style.height='12px'
    sw.style.borderRadius='6px'
    sw.style.background=state.colors[s.key]
    
    const lab = document.createElement('div')
    lab.textContent = s.name
    
    const colorInp = document.createElement('input')
    colorInp.type='color'
    colorInp.value = state.colors[s.key]
    colorInp.addEventListener('input', (e)=>{ 
      state.colors[s.key] = e.target.value
      saveLocal()
      buildPalette()
      renderAll()
    })
    
    item.appendChild(sw)
    item.appendChild(lab)
    item.appendChild(colorInp)
    legend.appendChild(item)
  })
  
  highlightSelected()
}

function highlightSelected(){ 
  palette.querySelectorAll('.subject-btn').forEach(b=>{ 
    if(b.dataset.key === sel) {
      b.style.boxShadow = '0 6px 20px rgba(2,6,23,0.12)'
    } else {
      b.style.boxShadow = 'none'
    }
  })
}

addSubjectBtn.addEventListener('click', ()=>{ 
  const name = (newSubjectName.value||'').trim()
  const color = newSubjectColor.value || '#7c3aed'
  
  if(!name) return alert('æ•™ç§‘åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
  
  let key = name.toLowerCase().replace(/[^\w]+/g,'_')
  let base = key, suffix = 1
  while(SUBJECTS.some(s=>s.key === key)){ 
    key = base + '_' + (suffix++)
  }
  
  const subj = { key, name, color }
  SUBJECTS.push(subj)
  state.colors[key] = color
  newSubjectName.value = ''
  buildPalette()
  saveLocal()
})

/* ==========================================
   Grid Rendering
   ========================================== */
function buildGrid(){ 
  hoursGrid.innerHTML = ''
  for(let h=0; h<24; h++){
    const col = document.createElement('div')
    col.className='hour-col'
    col.dataset.hour = h
    
    const header = document.createElement('div')
    header.className='hour-header'
    header.textContent = `${h}:00`
    
    const cell = document.createElement('div')
    cell.className='hour-cell'
    cell.addEventListener('click', ()=> onHourClick(h))
    
    col.appendChild(header)
    col.appendChild(cell)
    hoursGrid.appendChild(col)
  }
}

function renderCell(dateStr, hour){ 
  ensureDay(dateStr)
  const segs = state.hourSegments[dateStr][hour]
  const col = hoursGrid.querySelector(`.hour-col[data-hour='${hour}']`)
  if(!col) return
  
  const cell = col.querySelector('.hour-cell')
  cell.innerHTML = ''
  
  const wrap = document.createElement('div')
  wrap.className='segments'
  
  for(let i=0;i<SEG_H;i++){ 
    const s = segs[i]
    const segDiv = document.createElement('div')
    segDiv.className='segment'
    
    const fill = document.createElement('div')
    fill.className='fill'
    const pct = Math.max(0, Math.min(1, (s.filledMs||0)/SEG_MS))
    fill.style.width = (pct*100) + '%'
    
    if(s.subject && state.colors[s.subject]) {
      fill.style.background = `linear-gradient(90deg, ${state.colors[s.subject]}, ${shade(state.colors[s.subject],-8)})`
    }
    
    segDiv.appendChild(fill)
    wrap.appendChild(segDiv)
  }
  
  const label = document.createElement('div')
  label.className='cell-label'
  const allSubjs = new Set(segs.map(s=>s.subject||''))
  if(allSubjs.size === 1 && !allSubjs.has('')) {
    label.textContent = SUBJECTS.find(x=>x.key===segs[0].subject)?.name || ''
  }
  
  const overlay = document.createElement('div')
  overlay.className='overlay'
  const totalFilled = segs.reduce((a,b)=>a+(b.filledMs||0),0)
  overlay.textContent = (totalFilled >= 3600000) ? 'å®Œäº†' : ''
  
  cell.appendChild(wrap)
  cell.appendChild(label)
  cell.appendChild(overlay)
}

function renderAll(){ 
  if(!dateInput.value) dateInput.value = todayY()
  const dateStr = dateInput.value
  ensureDay(dateStr)
  
  for(let h=0; h<24; h++) renderCell(dateStr,h)
  
  updateElapsedDisplay()
  updateButtonStyles()
  saveLocal()
}

function onHourClick(hour){ 
  const dateStr = dateInput.value
  ensureDay(dateStr)
  const segs = state.hourSegments[dateStr][hour]
  let changed = false
  
  for(let i=0;i<SEG_H;i++){ 
    if(segs[i].filledMs === 0 && segs[i].subject !== sel){ 
      segs[i].subject = sel
      changed = true
    }
  }
  
  if(changed){ 
    renderAll()
  }
}

/* ==========================================
   Timer Logic
   ========================================== */
function getSegmentStartMs(ts){ 
  const d = new Date(ts)
  const dayStart = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime()
  const minutesSinceDay = Math.floor((ts - dayStart)/60000)
  const segIndexOverall = Math.floor(minutesSinceDay / SEG_MIN)
  return dayStart + segIndexOverall * SEG_MS
}

function allocateDelta(prevMs, nowMs){ 
  if(nowMs <= prevMs) return
  
  let cur = prevMs
  const subject = sel
  
  while(cur < nowMs){ 
    const segStart = getSegmentStartMs(cur)
    const segEnd = segStart + SEG_MS
    const addAvailable = Math.min(segEnd, nowMs) - cur
    
    const d = new Date(segStart)
    const dateStr = ymd(d)
    const hour = d.getHours()
    const minutesSinceHour = Math.floor((segStart - new Date(d.getFullYear(), d.getMonth(), d.getDate(), hour).getTime())/60000)
    const segIndex = Math.floor(minutesSinceHour / SEG_MIN)
    
    ensureDay(dateStr)
    const seg = state.hourSegments[dateStr][hour][segIndex]
    const before = seg.filledMs || 0
    const canAdd = Math.min(SEG_MS - before, addAvailable)
    
    if(canAdd > 0){ 
      if(!seg.subject) seg.subject = subject
      seg.filledMs = before + canAdd
      state.timer.sessionAccumulatedMs = (state.timer.sessionAccumulatedMs || 0) + canAdd
      cur += canAdd
    } else { 
      cur = segEnd
    }
  }
}

function tick(){ 
  const now = Date.now()
  const prev = state.timer._lastTick || now
  allocateDelta(prev, now)
  state.timer._lastTick = now
  updateElapsedDisplay()
  renderAll()
}

function updateElapsedDisplay(){ 
  elapsedLabel.textContent = fmt(state.timer.sessionAccumulatedMs || 0)
  
  const dateStr = dateInput.value
  ensureDay(dateStr)
  const todayMs = state.hourSegments[dateStr].reduce((a,h)=>
    a + h.reduce((aa,seg)=>aa + (seg.filledMs||0),0)
  ,0)
  todayTotalLabel.textContent = fmt(todayMs)
}

function startTimer(){ 
  if(state.timer.running) return
  
  state.timer.running = true
  state.timer._lastTick = Date.now()
  window._tickI = setInterval(tick, 1000)
  updateButtonStyles()
  saveLocal()
}

async function pauseTimer(){
  if(!state.timer.running) return
  
  console.log('â¸ï¸ ã‚¿ã‚¤ãƒãƒ¼åœæ­¢å‡¦ç†é–‹å§‹')
  
  // æœ€å¾Œã®tick
  tick()
  
  // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
  state.timer.running = false
  clearInterval(window._tickI)
  state.timer._lastTick = null
  
  // å‹‰å¼·æ™‚é–“ã‚’å–å¾—
  const studyTimeMs = state.timer.sessionAccumulatedMs || 0
  console.log('ğŸ“Š è¨˜éŒ²ã™ã‚‹å‹‰å¼·æ™‚é–“:', studyTimeMs, 'ms (', (studyTimeMs/60000).toFixed(1), 'åˆ†)')
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
  state.timer.sessionAccumulatedMs = 0
  
  // UIæ›´æ–°
  updateElapsedDisplay()
  updateButtonStyles()
  saveLocal()
  renderAll()
  
  // Supabaseã«ä¿å­˜ï¼ˆ1ç§’ä»¥ä¸Šã®å ´åˆã®ã¿ï¼‰
  if(studyTimeMs >= 1000){
    if(!currentUser){
      console.warn('âš ï¸ æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“')
      alert('æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚')
      return
    }
    
    try{
      console.log('ğŸ’¾ Supabaseã¸ä¿å­˜é–‹å§‹...')
      
      const now = new Date()
      const dateStr = ymd(now)
      
      const { data, error } = await supabase
        .from('study_records')
        .insert([{
          user_id: currentUser.id,
          study_date: dateStr,
          study_time_ms: studyTimeMs,
          recorded_at: now.toISOString()
        }])
      
      if(error){
        console.error('âŒ Supabaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error)
        alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      } else {
        console.log('âœ… Supabaseä¿å­˜æˆåŠŸ')
        alert(`ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼\n${fmt(studyTimeMs)} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`)
      }
    }catch(e){
      console.error('âŒ ä¿å­˜å‡¦ç†ã®ä¾‹å¤–:', e)
      alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    }
  } else {
    console.log('â­ï¸ 1ç§’æœªæº€ã®ãŸã‚ä¿å­˜ã‚¹ã‚­ãƒƒãƒ—')
  }
  
  console.log('â¸ï¸ ã‚¿ã‚¤ãƒãƒ¼åœæ­¢å‡¦ç†å®Œäº†')
}

function resetTimer(){ 
  if(!confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç´¯ç©ã¯0ã«æˆ»ã‚Šã¾ã™ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return
  
  state.timer.running = false
  clearInterval(window._tickI)
  state.timer._lastTick = null
  state.timer.sessionAccumulatedMs = 0
  
  updateElapsedDisplay()
  updateButtonStyles()
  saveLocal()
  renderAll()
}

function onSetNow(){ 
  startTimeInput.value = timeIn(new Date())
}

function updateButtonStyles(){ 
  if(state.timer.running){ 
    startBtn.textContent = 'åœæ­¢'
    startBtn.classList.add('running')
  } else { 
    startBtn.textContent = 'é–‹å§‹'
    startBtn.classList.remove('running')
  }
}

/* ==========================================
   Event Bindings
   ========================================== */
startBtn.addEventListener('click', ()=> {
  if(state.timer.running){
    pauseTimer()
  } else {
    startTimer()
  }
})

resetBtn.addEventListener('click', resetTimer)
setNowBtn.addEventListener('click', onSetNow)
dateInput.addEventListener('change', ()=> renderAll())

/* ==========================================
   Initialization
   ========================================== */
(async function init(){
  console.log('ğŸš€ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹')
  
  loadLocal()
  
  if(!dateInput.value) dateInput.value = todayY()
  if(!startTimeInput.value) startTimeInput.value = timeIn(new Date())
  
  buildPalette()
  buildGrid()
  renderAll()
  
  // èªè¨¼ç¢ºèª
  await checkAuth()
  
  console.log('âœ… ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†')
})()
</script>
</body>
</html>
