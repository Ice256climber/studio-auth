<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studio Auth — サインイン / サインアップ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-white flex items-center justify-center p-6">
  <main class="w-full max-w-lg bg-white/95 backdrop-blur-md border border-gray-200 rounded-2xl shadow-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-semibold">アカウント</h1>
      <div class="text-sm text-gray-500">先生 / 生徒 を選択して登録できます</div>
    </div>

    <div id="status" class="mb-4 text-sm text-gray-600">読み込み中…</div>

    <div class="grid grid-cols-1 gap-4">
      <button id="btn-google" class="w-full py-3 rounded-xl bg-white border flex items-center justify-center gap-3 hover:shadow">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 533.5 544.3" class="w-5 h-5"><path fill="#4285f4" d="M533.5 278.4c0-18.3-1.6-36-4.7-53.1H272v100.6h146.9c-6.3 34-25.7 62.8-54.9 82v68.1h88.6c51.9-47.8 81.9-118.3 81.9-197.6z"/><path fill="#34a853" d="M272 544.3c73.8 0 135.8-24.6 181.1-66.9l-88.6-68.1c-24.6 16.5-56 26.3-92.5 26.3-71 0-131.3-47.9-152.8-112.2H29.5v70.6C74.8 489.6 167 544.3 272 544.3z"/><path fill="#fbbc04" d="M119.2 325.6c-10.6-31.4-10.6-65.6 0-97l-89.8-70.6C7.5 197 0 234 0 272s7.5 75 29.4 113.1l89.8-59.5z"/><path fill="#ea4335" d="M272 107.7c39.9 0 75.7 13.7 103.9 40.6l78-78C407.8 25.7 345.8 0 272 0 167 0 74.8 54.7 29.5 137.4l89.8 70.6C140.7 155.6 201 107.7 272 107.7z"/></svg>
        Googleで続行（推奨）
      </button>

      <div class="p-4 rounded-lg border bg-gray-50">
        <label class="block text-xs text-gray-600">メールアドレス</label>
        <input id="email" type="email" class="w-full mt-1 p-2 rounded border" placeholder="you@example.com" />

        <label class="block text-xs text-gray-600 mt-3">パスワード</label>
        <input id="password" type="password" class="w-full mt-1 p-2 rounded border" placeholder="8文字以上" />

        <div class="mt-3 flex gap-2">
          <select id="role" class="p-2 rounded border">
            <option value="student">生徒</option>
            <option value="teacher">先生</option>
          </select>
          <button id="btn-signup" class="ml-auto py-2 px-4 rounded bg-green-600 text-white">サインアップ</button>
          <button id="btn-signin" class="py-2 px-4 rounded border">サインイン</button>
        </div>

        <div class="mt-3 text-center">
          <button id="btn-reset" class="text-xs text-gray-500">パスワードリセット</button>
        </div>
      </div>

      <div id="after" class="hidden mt-2 p-4 rounded border bg-white">
        <h2 class="font-medium" id="welcomeTitle"></h2>
        <p class="text-sm text-gray-600" id="welcomeBody"></p>
        <div class="mt-3 flex gap-2">
          <button id="btn-signout" class="py-2 px-4 rounded border">サインアウト</button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    window.supabase = supabase // デバッグ用に公開（コンソールから使える）

    const statusEl = document.getElementById('status')
    const btnGoogle = document.getElementById('btn-google')
    const btnSignin = document.getElementById('btn-signin')
    const btnSignup = document.getElementById('btn-signup')
    const btnReset = document.getElementById('btn-reset')
    const btnSignout = document.getElementById('btn-signout')
    const emailInput = document.getElementById('email')
    const passwordInput = document.getElementById('password')
    const roleSelect = document.getElementById('role')
    const afterEl = document.getElementById('after')
    const welcomeTitle = document.getElementById('welcomeTitle')
    const welcomeBody = document.getElementById('welcomeBody')

    function showStatus(msg) {
      statusEl.innerText = msg
    }

    async function refreshSession() {
      try {
        const { data } = await supabase.auth.getSession()
        const session = data?.session
        if (session) {
          // get role from users table (we'll use public 'users' table)
          const { data: userRow, error } = await supabase.from('users').select('role').eq('id', session.user.id).maybeSingle()
          const role = userRow?.role || 'student'
          showSignedIn(session.user.email, role)
          return session
        } else {
          showStatus('サインインしていません。')
          return null
        }
      } catch (e) {
        console.error(e)
        showStatus('セッション確認エラー')
        return null
      }
    }

    function showSignedIn(email, role) {
      afterEl.classList.remove('hidden')
      welcomeTitle.innerText = role === 'teacher' ? '先生ようこそ！' : '生徒さんようこそ！'
      welcomeBody.innerText = `ログイン: ${email}\n役割: ${role}`
      showStatus('ログイン済み')
    }

    // open popup for OAuth
    function openAuthPopup(path) {
      const w = 600, h = 700
      const left = (screen.width/2)-(w/2)
      const top = (screen.height/2)-(h/2)
      const popup = window.open(path, 'auth_popup', `width=${w},height=${h},left=${left},top=${top}`)
      if (!popup) {
        showStatus('ポップアップがブロックされました。許可してください。')
        return null
      }
      showStatus('認証ポップアップを開きました。')
      return popup
    }

    // handle messages from popup
    window.addEventListener('message', async (ev) => {
      // TODO: 本番では ev.origin をチェックすること
      const data = ev.data || {}
      if (data.type === 'supabase_auth') {
        if (data.error) {
          showStatus('認証エラー: ' + data.error)
          return
        }
        const session = data.session
        // after OAuth, ensure user has role; if not, prompt
        const userId = session.user.id
        const { data: userRow } = await supabase.from('users').select('role').eq('id', userId).maybeSingle()
        if (!userRow || !userRow.role) {
          // ask user to choose role (simple prompt)
          const chosen = confirm('ロールが設定されていません。先生ならOKを押してください（OK=先生, キャンセル=生徒）')
          const role = chosen ? 'teacher' : 'student'
          await supabase.from('users').upsert({ id: userId, role })
          showSignedIn(session.user.email, role)
        } else {
          showSignedIn(session.user.email, userRow.role)
        }
      }
    }, false)

    // Google button: open popup that handles supabase OAuth
    btnGoogle.addEventListener('click', () => {
      openAuthPopup('/auth-popup.html?provider=google')
    })

    btnSignup.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      const password = passwordInput.value
      const role = roleSelect.value
      if (!email || password.length < 8) {
        showStatus('メールと8文字以上のパスワードを入力してください')
        return
      }
      btnSignup.disabled = true
      showStatus('サインアップ中...')
      try {
        const { data, error } = await supabase.auth.signUp({ email, password })
        if (error) throw error
        // user created (might require email confirmation); upsert role to users table
        if (data?.user?.id) {
          await supabase.from('users').upsert({ id: data.user.id, role })
        }
        showStatus('登録完了。確認メールを確認してください（メール確認が不要な設定の場合はそのままサインインできます）')
      } catch (e) {
        showStatus('エラー: ' + (e.message || e))
      } finally {
        btnSignup.disabled = false
      }
    })

    btnSignin.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      const password = passwordInput.value
      if (!email || password.length < 8) {
        showStatus('メールと8文字以上のパスワードを入力してください')
        return
      }
      btnSignin.disabled = true
      showStatus('サインイン中...')
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password })
        if (error) throw error
        // get role and show
        const userId = data.user.id
        const { data: userRow } = await supabase.from('users').select('role').eq('id', userId).maybeSingle()
        const role = userRow?.role || 'student'
        showSignedIn(data.user.email, role)
      } catch (e) {
        showStatus('エラー: ' + (e.message || e))
      } finally {
        btnSignin.disabled = false
      }
    })

    btnReset.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      if (!email) {
        showStatus('メールを入力してください')
        return
      }
      btnReset.disabled = true
      showStatus('リセットメール送信中...')
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/password-reset.html' })
        if (error) throw error
        showStatus('リセットメールを送信しました。')
      } catch (e) {
        showStatus('エラー: ' + (e.message || e))
      } finally {
        btnReset.disabled = false
      }
    })

    btnSignout.addEventListener('click', async () => {
      await supabase.auth.signOut()
      afterEl.classList.add('hidden')
      showStatus('サインアウトしました。')
    })

    // initial check
    (async () => {
      await refreshSession()
    })()
  </script>
</body>
</html>

