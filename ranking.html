<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç¿’ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <style>
    :root{ --bg:#f6f8fb; --card:#fff; --accent:#4461f2; }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,'Noto Sans JP',sans-serif;background:var(--bg);margin:0;padding:20px;color:#0f1724}
    .container{max-width:900px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(16,24,40,0.06);margin-bottom:20px}
    h1{margin:0 0 20px 0;display:flex;justify-content:space-between;align-items:center}
    .refresh-btn{padding:8px 16px;background:var(--accent);color:#fff;border:0;border-radius:8px;cursor:pointer;font-weight:600}
    .refresh-btn:hover{opacity:0.9}
    .tabs{display:flex;gap:10px;margin-bottom:20px}
    .tab{padding:10px 20px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:600}
    .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .ranking-list{display:flex;flex-direction:column;gap:12px}
    .rank-item{display:flex;align-items:center;gap:16px;padding:16px;border-radius:10px;background:linear-gradient(90deg,#fbfbff,#fff);border:1px solid rgba(0,0,0,0.04)}
    .rank-number{font-size:24px;font-weight:800;color:var(--accent);min-width:50px}
    .rank-gold{color:#FFD700}
    .rank-silver{color:#C0C0C0}
    .rank-bronze{color:#CD7F32}
    .student-info{flex:1}
    .student-name{font-weight:700;font-size:16px}
    .student-id{font-size:13px;color:#6b7280}
    .time-info{text-align:right}
    .time-value{font-size:20px;font-weight:800;color:#0f1724}
    .time-label{font-size:12px;color:#6b7280}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:20px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:10px}
    .stat-value{font-size:28px;font-weight:800;margin-bottom:8px}
    .stat-label{font-size:14px;opacity:0.9}
    .loading{text-align:center;padding:40px;color:#6b7280}
    .error{background:#fee;color:#c00;padding:16px;border-radius:8px;margin-bottom:20px}
    .last-updated{font-size:13px;color:#6b7280;margin-top:10px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>

</head>
<body>
  <div class="container">
    <h1>
      <span>ğŸ“Š å­¦ç¿’ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
      <button class="refresh-btn" onclick="manualRefresh()">ğŸ”„ æ›´æ–°</button>
    </h1>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('weekly')">é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      <button class="tab" onclick="switchTab('daily')">æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      <button class="tab" onclick="switchTab('total')">ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>

    <div id="errorMessage" class="error" style="display:none"></div>
    
    <div class="card">
      <h2 id="rankingTitle">ğŸ“… éå»7æ—¥é–“ã®å­¦ç¿’æ™‚é–“</h2>
      <div class="last-updated" id="lastUpdated">æœ€çµ‚æ›´æ–°: èª­ã¿è¾¼ã¿ä¸­...</div>
      <div id="statsGrid" class="stats-grid"></div>
      <div id="rankingList" class="ranking-list"></div>
    </div>
  </div>

  <script>
    // UMDç‰ˆã§èª­ã¿è¾¼ã¾ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰createClientã‚’å–å¾—
    const { createClient } = window.supabase
    
    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    window.supabase = supabase

    let currentTab = 'weekly'

    const fmt = ms => {
      if(!ms) return '0:00:00'
      let s = Math.floor(ms/1000)
      let h = Math.floor(s/3600)
      s = s % 3600
      const m = Math.floor(s/60)
      const sec = s%60
      return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`
    }

    const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`

    function calculateStats(rankings) {
      if(!rankings.length) return null
      
      const total = rankings.reduce((sum, r) => sum + r.totalMs, 0)
      const avg = total / rankings.length
      const max = Math.max(...rankings.map(r => r.totalMs))
      
      return {
        participants: rankings.length,
        totalHours: (total / 3600000).toFixed(1),
        avgHours: (avg / 3600000).toFixed(1),
        maxHours: (max / 3600000).toFixed(1)
      }
    }

    function displayRanking(rankings, stats) {
      const listEl = document.getElementById('rankingList')
      const statsEl = document.getElementById('statsGrid')
      
      document.getElementById('lastUpdated').textContent = 
        `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP')}`
      
      if(!rankings.length) {
        listEl.innerHTML = '<div class="loading">ğŸ“­ è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br><small>ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã£ã¦å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†</small></div>'
        statsEl.innerHTML = ''
        return
      }

      if(stats) {
        statsEl.innerHTML = `
          <div class="stat-card" style="background:linear-gradient(135deg,#667eea,#764ba2)">
            <div class="stat-value">${stats.participants}</div>
            <div class="stat-label">å‚åŠ è€…æ•°</div>
          </div>
          <div class="stat-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
            <div class="stat-value">${stats.totalHours}h</div>
            <div class="stat-label">åˆè¨ˆå­¦ç¿’æ™‚é–“</div>
          </div>
          <div class="stat-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
            <div class="stat-value">${stats.avgHours}h</div>
            <div class="stat-label">å¹³å‡å­¦ç¿’æ™‚é–“</div>
          </div>
        `
      } else {
        statsEl.innerHTML = ''
      }

      listEl.innerHTML = rankings.map((item, idx) => {
        const rank = idx + 1
        let rankClass = ''
        let medal = ''
        if(rank === 1) { rankClass = 'rank-gold'; medal = 'ğŸ¥‡' }
        else if(rank === 2) { rankClass = 'rank-silver'; medal = 'ğŸ¥ˆ' }
        else if(rank === 3) { rankClass = 'rank-bronze'; medal = 'ğŸ¥‰' }
        
        return `
          <div class="rank-item">
            <div class="rank-number ${rankClass}">${medal || '#' + rank}</div>
            <div class="student-info">
              <div class="student-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${item.user_id.slice(0,8)}</div>
              <div class="student-id">${item.recordCount}å›ã®å­¦ç¿’è¨˜éŒ²</div>
            </div>
            <div class="time-info">
              <div class="time-value">${fmt(item.totalMs)}</div>
              <div class="time-label">${(item.totalMs/3600000).toFixed(1)} æ™‚é–“</div>
            </div>
          </div>
        `
      }).join('')
    }

    async function fetchWeeklyRanking() {
      try {
        const today = new Date()
        const sevenDaysAgo = new Date(today)
        sevenDaysAgo.setDate(today.getDate() - 6)
        
        const startDate = ymd(sevenDaysAgo)
        const endDate = ymd(today)
        
        console.log('ğŸ“… é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—:', startDate, '~', endDate)
        
        const { data, error } = await supabase
          .from('study_records')
          .select('user_id, study_time_ms')
          .gte('study_date', startDate)
          .lte('study_date', endDate)
        
        if(error) throw error
        
        console.log('âœ… å–å¾—ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:', data?.length || 0)
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é›†è¨ˆ
        const userTotals = {}
        data.forEach(record => {
          if(!userTotals[record.user_id]) {
            userTotals[record.user_id] = { totalMs: 0, recordCount: 0 }
          }
          userTotals[record.user_id].totalMs += record.study_time_ms
          userTotals[record.user_id].recordCount++
        })
        
        const rankings = Object.entries(userTotals)
          .map(([user_id, stats]) => ({
            user_id,
            totalMs: stats.totalMs,
            recordCount: stats.recordCount
          }))
          .sort((a, b) => b.totalMs - a.totalMs)
        
        console.log('ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°çµæœ:', rankings.length, 'äºº')
        
        const stats = calculateStats(rankings)
        displayRanking(rankings, stats)
        
      } catch(error) {
        console.error('âŒ é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        showError('é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    }

    async function fetchDailyRanking() {
      try {
        const today = ymd(new Date())
        
        console.log('ğŸ“† æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—:', today)
        
        const { data, error } = await supabase
          .from('study_records')
          .select('user_id, study_time_ms')
          .eq('study_date', today)
        
        if(error) throw error
        
        console.log('âœ… å–å¾—ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:', data?.length || 0)
        
        const userTotals = {}
        data.forEach(record => {
          if(!userTotals[record.user_id]) {
            userTotals[record.user_id] = { totalMs: 0, recordCount: 0 }
          }
          userTotals[record.user_id].totalMs += record.study_time_ms
          userTotals[record.user_id].recordCount++
        })
        
        const rankings = Object.entries(userTotals)
          .map(([user_id, stats]) => ({
            user_id,
            totalMs: stats.totalMs,
            recordCount: stats.recordCount
          }))
          .sort((a, b) => b.totalMs - a.totalMs)
        
        const stats = calculateStats(rankings)
        displayRanking(rankings, stats)
        
      } catch(error) {
        console.error('âŒ æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        showError('æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    }

    async function fetchTotalRanking() {
      try {
        console.log('ğŸ† ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—')
        
        const { data, error } = await supabase
          .from('study_records')
          .select('user_id, study_time_ms')
        
        if(error) throw error
        
        console.log('âœ… å–å¾—ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:', data?.length || 0)
        
        const userTotals = {}
        data.forEach(record => {
          if(!userTotals[record.user_id]) {
            userTotals[record.user_id] = { totalMs: 0, recordCount: 0 }
          }
          userTotals[record.user_id].totalMs += record.study_time_ms
          userTotals[record.user_id].recordCount++
        })
        
        const rankings = Object.entries(userTotals)
          .map(([user_id, stats]) => ({
            user_id,
            totalMs: stats.totalMs,
            recordCount: stats.recordCount
          }))
          .sort((a, b) => b.totalMs - a.totalMs)
        
        const stats = calculateStats(rankings)
        displayRanking(rankings, stats)
        
      } catch(error) {
        console.error('âŒ ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        showError('ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage')
      errorEl.textContent = message
      errorEl.style.display = 'block'
      setTimeout(() => errorEl.style.display = 'none', 8000)
    }

    window.switchTab = function(tab) {
      currentTab = tab
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
      event.target.classList.add('active')
      
      const titles = {
        weekly: 'ğŸ“… éå»7æ—¥é–“ã®å­¦ç¿’æ™‚é–“',
        daily: 'ğŸ“† æœ¬æ—¥ã®å­¦ç¿’æ™‚é–“',
        total: 'ğŸ† ç´¯è¨ˆå­¦ç¿’æ™‚é–“'
      }
      document.getElementById('rankingTitle').textContent = titles[tab]
      
      document.getElementById('rankingList').innerHTML = '<div class="loading">â³ èª­ã¿è¾¼ã¿ä¸­...</div>'
      document.getElementById('statsGrid').innerHTML = ''
      
      if(tab === 'weekly') fetchWeeklyRanking()
      else if(tab === 'daily') fetchDailyRanking()
      else if(tab === 'total') fetchTotalRanking()
    }

    window.manualRefresh = function() {
      console.log('ğŸ”„ æ‰‹å‹•æ›´æ–°å®Ÿè¡Œ')
      if(currentTab === 'weekly') fetchWeeklyRanking()
      else if(currentTab === 'daily') fetchDailyRanking()
      else if(currentTab === 'total') fetchTotalRanking()
    }

    document.getElementById('rankingList').innerHTML = '<div class="loading">â³ èª­ã¿è¾¼ã¿ä¸­...</div>'
    fetchWeeklyRanking()

    console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†')
  </script>
</body>
</html>
