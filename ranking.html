<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç¿’ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <style>
    :root{ --bg:#f6f8fb; --card:#fff; --accent:#4461f2; }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,'Noto Sans JP',sans-serif;background:var(--bg);margin:0;padding:20px;color:#0f1724}
    .container{max-width:900px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(16,24,40,0.06);margin-bottom:20px}
    h1{margin:0 0 20px 0;display:flex;justify-content:space-between;align-items:center}
    .refresh-btn{padding:8px 16px;background:var(--accent);color:#fff;border:0;border-radius:8px;cursor:pointer;font-weight:600}
    .refresh-btn:hover{opacity:0.9}
    .tabs{display:flex;gap:10px;margin-bottom:20px}
    .tab{padding:10px 20px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:600}
    .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .ranking-list{display:flex;flex-direction:column;gap:12px}
    .rank-item{display:flex;align-items:center;gap:16px;padding:16px;border-radius:10px;background:linear-gradient(90deg,#fbfbff,#fff);border:1px solid rgba(0,0,0,0.04)}
    .rank-number{font-size:24px;font-weight:800;color:var(--accent);min-width:50px}
    .rank-gold{color:#FFD700}
    .rank-silver{color:#C0C0C0}
    .rank-bronze{color:#CD7F32}
    .student-info{flex:1}
    .student-name{font-weight:700;font-size:16px}
    .student-id{font-size:13px;color:#6b7280}
    .time-info{text-align:right}
    .time-value{font-size:20px;font-weight:800;color:#0f1724}
    .time-label{font-size:12px;color:#6b7280}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:20px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:10px}
    .stat-value{font-size:28px;font-weight:800;margin-bottom:8px}
    .stat-label{font-size:14px;opacity:0.9}
    .loading{text-align:center;padding:40px;color:#6b7280}
    .error{background:#fee;color:#c00;padding:16px;border-radius:8px;margin-bottom:20px}
    .debug-info{background:#f0f0f0;padding:12px;border-radius:8px;font-size:12px;margin-top:20px;font-family:monospace}
    .last-updated{font-size:13px;color:#6b7280;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span>ğŸ“Š å­¦ç¿’ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
      <button class="refresh-btn" onclick="manualRefresh()">ğŸ”„ æ›´æ–°</button>
    </h1>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('weekly')">é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      <button class="tab" onclick="switchTab('daily')">æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      <button class="tab" onclick="switchTab('total')">ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>

    <div id="errorMessage" class="error" style="display:none"></div>
    
    <div class="card">
      <h2 id="rankingTitle">ğŸ“… éå»7æ—¥é–“ã®å­¦ç¿’æ™‚é–“</h2>
      <div class="last-updated" id="lastUpdated">æœ€çµ‚æ›´æ–°: èª­ã¿è¾¼ã¿ä¸­...</div>
      <div id="statsGrid" class="stats-grid"></div>
      <div id="rankingList" class="ranking-list"></div>
      
      <details style="margin-top:20px">
        <summary style="cursor:pointer;font-weight:600">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</summary>
        <div id="debugInfo" class="debug-info">èª­ã¿è¾¼ã¿ä¸­...</div>
      </details>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    let currentTab = 'weekly'
    let debugData = {}

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    const fmt = ms => {
      if(!ms) return '0:00:00'
      let s = Math.floor(ms/1000)
      let h = Math.floor(s/3600)
      s = s % 3600
      const m = Math.floor(s/60)
      const sec = s%60
      return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`
    }

    const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
    
    const lastNDates = (endDateStr, n) => {
      const [y,m,d] = endDateStr.split('-').map(x=>parseInt(x,10))
      const end = new Date(y, m-1, d)
      const arr=[]
      for(let i=n-1;i>=0;i--){
        const dd = new Date(end)
        dd.setDate(end.getDate()-i)
        arr.push(ymd(dd))
      }
      return arr
    }

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    function updateDebugInfo() {
      const debugEl = document.getElementById('debugInfo')
      debugEl.innerHTML = `
        <strong>ç¾åœ¨æ™‚åˆ»:</strong> ${new Date().toLocaleString('ja-JP')}<br>
        <strong>å¯¾è±¡æ—¥ä»˜:</strong> ${debugData.targetDates?.join(', ') || 'æœªå–å¾—'}<br>
        <strong>å–å¾—ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:</strong> ${debugData.userCount || 0}<br>
        <strong>ãƒ‡ãƒ¼ã‚¿ã‚ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:</strong> ${debugData.validUserCount || 0}<br>
        <strong>ãƒ‡ãƒ¼ã‚¿ä¾‹:</strong><br>
        <pre style="margin-top:8px;overflow:auto">${JSON.stringify(debugData.sample, null, 2)}</pre>
      `
    }

    // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
    function calculateStats(rankings) {
      if(!rankings.length) return null
      
      const total = rankings.reduce((sum, r) => sum + r.totalMs, 0)
      const avg = total / rankings.length
      const max = Math.max(...rankings.map(r => r.totalMs))
      
      return {
        participants: rankings.length,
        totalHours: (total / 3600000).toFixed(1),
        avgHours: (avg / 3600000).toFixed(1),
        maxHours: (max / 3600000).toFixed(1)
      }
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
    function displayRanking(rankings, stats) {
      const listEl = document.getElementById('rankingList')
      const statsEl = document.getElementById('statsGrid')
      
      // æœ€çµ‚æ›´æ–°æ™‚åˆ»
      document.getElementById('lastUpdated').textContent = 
        `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP')}`
      
      if(!rankings.length) {
        listEl.innerHTML = '<div class="loading">ğŸ“­ è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br><small>ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã£ã¦å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†</small></div>'
        statsEl.innerHTML = ''
        return
      }

      // çµ±è¨ˆæƒ…å ±
      if(stats) {
        statsEl.innerHTML = `
          <div class="stat-card" style="background:linear-gradient(135deg,#667eea,#764ba2)">
            <div class="stat-value">${stats.participants}</div>
            <div class="stat-label">å‚åŠ è€…æ•°</div>
          </div>
          <div class="stat-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
            <div class="stat-value">${stats.totalHours}h</div>
            <div class="stat-label">åˆè¨ˆå­¦ç¿’æ™‚é–“</div>
          </div>
          <div class="stat-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
            <div class="stat-value">${stats.avgHours}h</div>
            <div class="stat-label">å¹³å‡å­¦ç¿’æ™‚é–“</div>
          </div>
        `
      } else {
        statsEl.innerHTML = ''
      }

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ
      listEl.innerHTML = rankings.map((item, idx) => {
        const rank = idx + 1
        let rankClass = ''
        let medal = ''
        if(rank === 1) { rankClass = 'rank-gold'; medal = 'ğŸ¥‡' }
        else if(rank === 2) { rankClass = 'rank-silver'; medal = 'ğŸ¥ˆ' }
        else if(rank === 3) { rankClass = 'rank-bronze'; medal = 'ğŸ¥‰' }
        
        return `
          <div class="rank-item">
            <div class="rank-number ${rankClass}">${medal || '#' + rank}</div>
            <div class="student-info">
              <div class="student-name">${item.email || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
              <div class="student-id">ID: ${item.user_id.slice(0,8)}...</div>
            </div>
            <div class="time-info">
              <div class="time-value">${fmt(item.totalMs)}</div>
              <div class="time-label">${(item.totalMs/3600000).toFixed(1)} æ™‚é–“</div>
            </div>
          </div>
        `
      }).join('')
    }

    // é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
    async function fetchWeeklyRanking() {
      try {
        const today = ymd(new Date())
        const days = lastNDates(today, 7)
        
        debugData.targetDates = days
        
        console.log('ğŸ“… é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹')
        console.log('å¯¾è±¡æ—¥ä»˜:', days)
        
        // Supabaseã‹ã‚‰å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const { data: allUsers, error: usersError } = await supabase
          .from('user_hours')
          .select('user_id, data')
        
        if(usersError) throw usersError

        console.log('âœ… å–å¾—ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', allUsers?.length || 0)
        debugData.userCount = allUsers?.length || 0

        // user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        const emailMap = {}
        try {
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('user_id, email, role')
          
          if(profiles) {
            profiles.forEach(p => emailMap[p.user_id] = p.email)
          }
        } catch(e) {
          console.warn('user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºãªã—ï¼‰')
        }

        // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€±é–“åˆè¨ˆã‚’è¨ˆç®—
        const rankings = allUsers.map(user => {
          let totalMs = 0
          const hourData = user.data || {}
          
          console.log(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.user_id.slice(0,8)}: ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼æ•° ${Object.keys(hourData).length}`)
          
          days.forEach(day => {
            if(hourData[day]) {
              const dayTotal = hourData[day].reduce((sum, hour) => 
                sum + hour.reduce((s, seg) => s + (seg.filledMs || 0), 0), 0
              )
              totalMs += dayTotal
              console.log(`  ${day}: ${fmt(dayTotal)}`)
            }
          })
          
          return {
            user_id: user.user_id,
            email: emailMap[user.user_id] || null,
            totalMs
          }
        }).filter(r => r.totalMs > 0)
        .sort((a, b) => b.totalMs - a.totalMs)

        console.log('ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°çµæœ:', rankings.length, 'äºº')
        
        debugData.validUserCount = rankings.length
        debugData.sample = rankings.slice(0, 2)
        
        updateDebugInfo()

        const stats = calculateStats(rankings)
        displayRanking(rankings, stats)
        
      } catch(error) {
        console.error('âŒ é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        showError('é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
        debugData.error = error.message
        updateDebugInfo()
      }
    }

    // æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
    async function fetchDailyRanking() {
      try {
        const today = ymd(new Date())
        
        debugData.targetDates = [today]
        
        console.log('ğŸ“† æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹:', today)
        
        const { data: allUsers, error: usersError } = await supabase
          .from('user_hours')
          .select('user_id, data')
        
        if(usersError) throw usersError

        debugData.userCount = allUsers?.length || 0

        const emailMap = {}
        try {
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('user_id, email')
          
          if(profiles) {
            profiles.forEach(p => emailMap[p.user_id] = p.email)
          }
        } catch(e) {
          console.warn('user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºãªã—ï¼‰')
        }

        const rankings = allUsers.map(user => {
          let totalMs = 0
          const hourData = user.data || {}
          
          if(hourData[today]) {
            totalMs = hourData[today].reduce((sum, hour) => 
              sum + hour.reduce((s, seg) => s + (seg.filledMs || 0), 0), 0
            )
            console.log(`ğŸ‘¤ ${user.user_id.slice(0,8)}: æœ¬æ—¥ ${fmt(totalMs)}`)
          }
          
          return {
            user_id: user.user_id,
            email: emailMap[user.user_id] || null,
            totalMs
          }
        }).filter(r => r.totalMs > 0)
        .sort((a, b) => b.totalMs - a.totalMs)

        debugData.validUserCount = rankings.length
        debugData.sample = rankings.slice(0, 2)
        updateDebugInfo()

        const stats = calculateStats(rankings)
        displayRanking(rankings, stats)
        
      } catch(error) {
        console.error('âŒ æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        showError('æœ¬æ—¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    }

    // ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
    async function fetchTotalRanking() {
      try {
        console.log('ğŸ† ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹')
        
        const { data: allUsers, error: usersError } = await supabase
          .from('user_hours')
          .select('user_id, data')
        
        if(usersError) throw usersError

        debugData.userCount = allUsers?.length || 0

        const emailMap = {}
        try {
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('user_id, email')
          
          if(profiles) {
            profiles.forEach(p => emailMap[p.user_id] = p.email)
          }
        } catch(e) {
          console.warn('user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºãªã—ï¼‰')
        }

        const rankings = allUsers.map(user => {
          let totalMs = 0
          const hourData = user.data || {}
          
          const allDays = Object.keys(hourData)
          debugData.targetDates = allDays
          
          allDays.forEach(day => {
            totalMs += hourData[day].reduce((sum, hour) => 
              sum + hour.reduce((s, seg) => s + (seg.filledMs || 0), 0), 0
            )
          })
          
          return {
            user_id: user.user_id,
            email: emailMap[user.user_id] || null,
            totalMs
          }
        }).filter(r => r.totalMs > 0)
        .sort((a, b) => b.totalMs - a.totalMs)

        debugData.validUserCount = rankings.length
        debugData.sample = rankings.slice(0, 2)
        updateDebugInfo()

        const stats = calculateStats(rankings)
        displayRanking(rankings, stats)
        
      } catch(error) {
        console.error('âŒ ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        showError('ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage')
      errorEl.textContent = message
      errorEl.style.display = 'block'
      setTimeout(() => errorEl.style.display = 'none', 8000)
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    window.switchTab = function(tab) {
      currentTab = tab
      
      // ã‚¿ãƒ–UIã®æ›´æ–°
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
      event.target.classList.add('active')
      
      // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
      const titles = {
        weekly: 'ğŸ“… éå»7æ—¥é–“ã®å­¦ç¿’æ™‚é–“',
        daily: 'ğŸ“† æœ¬æ—¥ã®å­¦ç¿’æ™‚é–“',
        total: 'ğŸ† ç´¯è¨ˆå­¦ç¿’æ™‚é–“'
      }
      document.getElementById('rankingTitle').textContent = titles[tab]
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      document.getElementById('rankingList').innerHTML = '<div class="loading">â³ èª­ã¿è¾¼ã¿ä¸­...</div>'
      document.getElementById('statsGrid').innerHTML = ''
      
      // ãƒ‡ãƒ¼ã‚¿å–å¾—
      if(tab === 'weekly') fetchWeeklyRanking()
      else if(tab === 'daily') fetchDailyRanking()
      else if(tab === 'total') fetchTotalRanking()
    }

    // æ‰‹å‹•æ›´æ–°
    window.manualRefresh = function() {
      console.log('ğŸ”„ æ‰‹å‹•æ›´æ–°å®Ÿè¡Œ')
      if(currentTab === 'weekly') fetchWeeklyRanking()
      else if(currentTab === 'daily') fetchDailyRanking()
      else if(currentTab === 'total') fetchTotalRanking()
    }

    // åˆæœŸè¡¨ç¤º
    document.getElementById('rankingList').innerHTML = '<div class="loading">â³ èª­ã¿è¾¼ã¿ä¸­...</div>'
    fetchWeeklyRanking()

    // è‡ªå‹•æ›´æ–°ã¯åœæ­¢ï¼ˆæ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ï¼‰
    console.log('âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†')
  </script>
</body>
</html>
