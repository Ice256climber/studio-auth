<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹³å‡ã‚°ãƒ©ãƒ• (å˜ä½“æ©Ÿèƒ½ç‰ˆ)</title>
  <style>
    /* å¿…è¦ãªã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿å®šç¾© */
    :root { 
      --bg: #f6f8fb; 
      --card: #ffffff; 
      --text: #0f1724;
      --text-sub: #6b7280;
      --avg-color: #10b981; /* å¹³å‡ç”¨ã®ç·‘è‰² */
    }

    * { box-sizing: border-box; }
    body { font-family: Inter, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
    
    /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .avg-card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
      max-width: 500px; /* å˜ä½“è¡¨ç¤ºç”¨ã«è¦‹ã‚„ã™ãåˆ¶é™ */
      margin: 0 auto;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .title { font-size: 20px; font-weight: 700; color: var(--avg-color); margin-bottom: 4px; }
    .subtitle { font-size: 13px; color: var(--text-sub); }
    .total-time { font-size: 32px; font-weight: 800; color: var(--avg-color); }
    .total-label { font-size: 11px; color: var(--text-sub); margin-top: 4px; }
    
    .stats-row {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-box {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .stat-val { font-size: 22px; font-weight: 700; color: var(--avg-color); }
    .stat-lbl { font-size: 11px; color: var(--text-sub); margin-top: 4px; }
    
    .chart-area {
      width: 100%;
      position: relative;
    }

    .loading-status {
      text-align: center;
      padding: 40px;
      color: var(--text-sub);
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>

</head>
<body>
  <div class="avg-card" id="averageCardContainer">
    <div class="loading-status">
        ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
    </div>
  </div>

  <script>
    // UMDç‰ˆã§èª­ã¿è¾¼ã¾ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰createClientã‚’å–å¾—
    const { createClient } = window.supabase

    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`

    function lastNDates(n) {
      const today = new Date()
      const arr = []
      for(let i = n-1; i >= 0; i--) {
        const d = new Date(today)
        d.setDate(today.getDate() - i)
        arr.push(ymd(d))
      }
      return arr
    }

    function drawChart(canvasId, dates, values) {
      const canvas = document.getElementById(canvasId)
      if (!canvas) return
      
      const ctx = canvas.getContext('2d')
      const width = canvas.width
      const height = canvas.height
      
      // èƒŒæ™¯
      ctx.fillStyle = '#ffffff'
      ctx.fillRect(0, 0, width, height)
      
      // ã‚°ãƒªãƒƒãƒ‰ç·š
      ctx.strokeStyle = '#f0f0f0'
      ctx.lineWidth = 1
      for(let i = 0; i <= 4; i++) {
        const y = (height - 40) * (i / 4) + 10
        ctx.beginPath()
        ctx.moveTo(40, y)
        ctx.lineTo(width - 10, y)
        ctx.stroke()
      }
      
      const maxValue = Math.max(...values, 1)
      const stepX = (width - 60) / (dates.length - 1)
      
      // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
      const points = values.map((val, i) => ({
        x: 40 + i * stepX,
        y: 10 + (height - 50) * (1 - val / maxValue)
      }))
      
      // ã‚¨ãƒªã‚¢å¡—ã‚Šã¤ã¶ã—
      ctx.fillStyle = 'rgba(16, 185, 129, 0.1)' // --avg-color ã®é€æ˜åº¦ä»˜ã
      ctx.beginPath()
      ctx.moveTo(points[0].x, height - 30)
      points.forEach(p => ctx.lineTo(p.x, p.y))
      ctx.lineTo(points[points.length - 1].x, height - 30)
      ctx.closePath()
      ctx.fill()
      
      // æŠ˜ã‚Œç·š
      ctx.strokeStyle = '#10b981' // --avg-color
      ctx.lineWidth = 3
      ctx.beginPath()
      ctx.moveTo(points[0].x, points[0].y)
      points.forEach(p => ctx.lineTo(p.x, p.y))
      ctx.stroke()
      
      // ãƒã‚¤ãƒ³ãƒˆ
      points.forEach((p, i) => {
        ctx.fillStyle = '#10b981'
        ctx.beginPath()
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2)
        ctx.fill()
        
        // å€¤ãƒ©ãƒ™ãƒ«
        ctx.fillStyle = '#0f1724'
        ctx.font = '11px Inter, sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText(values[i].toFixed(1) + 'h', p.x, p.y - 10)
      })
      
      // æ—¥ä»˜ãƒ©ãƒ™ãƒ«
      dates.forEach((date, i) => {
        const x = 40 + i * stepX
        ctx.fillStyle = '#6b7280'
        ctx.font = '10px Inter, sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText(date.slice(5), x, height - 10)
      })
    }

    async function loadAverageData() {
      try {
        console.log('ğŸ“Š å¹³å‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹')
        
        const dates = lastNDates(7)
        
        // éå»7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
        const { data: records, error } = await supabase
          .from('study_records')
          .select('user_id, study_date, study_time_ms')
          .gte('study_date', dates[0])
          .lte('study_date', dates[dates.length - 1])
        
        if (error) throw error
        
        // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã®ç‰¹å®š
        const uniqueUserIds = [...new Set(records.map(r => r.user_id))]
        const totalStudents = uniqueUserIds.length

        if (totalStudents === 0) {
            document.getElementById('averageCardContainer').innerHTML = `<div class="loading-status">ã¾ã å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`
            return
        }

        // å…¨ä½“ã®å¹³å‡ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
        const avgDailyValues = dates.map(date => {
            // ãã®æ—¥ã®å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã®åˆè¨ˆæ™‚é–“
            const dailySumMs = records
                .filter(r => r.study_date === date)
                .reduce((sum, r) => sum + r.study_time_ms, 0)
            
            // å¹³å‡è¨ˆç®— (ms -> hours)
            return (dailySumMs / totalStudents) / 3600000
        })

        // å…¨æœŸé–“ã®åˆè¨ˆå­¦ç¿’æ™‚é–“ï¼ˆä¸€äººã‚ãŸã‚Šå¹³å‡ï¼‰
        const totalAvgHours = avgDailyValues.reduce((sum, h) => sum + h, 0)
        
        // å…¨æœŸé–“ã®å¹³å‡å­¦ç¿’å›æ•°ã‚’è¨ˆç®— (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®å›æ•°ã‚’åˆè¨ˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã§å‰²ã‚‹)
        const userStudyCounts = {}
        records.forEach(r => {
            if (!userStudyCounts[r.user_id]) userStudyCounts[r.user_id] = 0
            userStudyCounts[r.user_id]++
        })
        const totalStudyCount = Object.values(userStudyCounts).reduce((sum, c) => sum + c, 0)
        const avgCountPerUser = totalStudyCount / totalStudents

        const maxAvgDay = Math.max(...avgDailyValues, 0)

        // HTMLå‡ºåŠ›
        document.getElementById('averageCardContainer').innerHTML = `
          <div class="card-header">
             <div>
                <div class="title">ã‚¯ãƒ©ã‚¹å¹³å‡</div>
                <div class="subtitle">å…¨ç”Ÿå¾’ã®å¹³å‡å­¦ç¿’æ¨ç§»ï¼ˆ${dates[0].slice(5)} ~ ${dates[dates.length - 1].slice(5)}ï¼‰</div>
              </div>
              <div>
                <div class="total-time">${totalAvgHours.toFixed(1)}h</div>
                <div class="total-label">1äººã‚ãŸã‚ŠæœŸé–“åˆè¨ˆ</div>
              </div>
            </div>
            
            <div class="stats-row">
              <div class="stat-box">
                <div class="stat-val">${avgCountPerUser.toFixed(1)}</div>
                <div class="stat-lbl">å¹³å‡å­¦ç¿’å›æ•°</div>
              </div>
              <div class="stat-box">
                <div class="stat-val">${(avgCountPerUser > 0 ? totalAvgHours / avgCountPerUser : 0).toFixed(1)}h</div>
                <div class="stat-lbl">1å›å¹³å‡</div>
              </div>
              <div class="stat-box">
                <div class="stat-val">${maxAvgDay.toFixed(1)}h</div>
                <div class="stat-lbl">æœ€é«˜å€¤(æ—¥)</div>
              </div>
            </div>

            <div class="chart-area">
              <canvas id="avgChartCanvas" width="450" height="220"></canvas>
            </div>
        `

        // æç”»å®Ÿè¡Œï¼ˆHTMLåæ˜ å¾Œï¼‰
        setTimeout(() => {
          drawChart('avgChartCanvas', dates, avgDailyValues)
        }, 50)

      } catch (e) {
        console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e)
        document.getElementById('averageCardContainer').innerHTML = `<p style="color:red">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}ã€‚Supabaseã®è¨­å®šã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>`
      }
    }
    
    // åˆæœŸåŒ–ã¨30ç§’ã”ã¨ã®æ›´æ–°
    loadAverageData()
    setInterval(loadAverageData, 30000)
  </script>
</body>
</html>
