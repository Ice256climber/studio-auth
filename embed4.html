<!doctype html>
<html lang="ja">
<head><!-- --- EMBED: session受信 + 高さ通知 + overflow:hidden --- -->
<style>
  /* embed 側ではスクロールを出さない */
  html, body { height:100%; margin:0; padding:0; overflow:hidden; }
  /* wrapper (UI) が長くなっても親側で高さを合わせるので内部スクロールは不要 */
  .wrap{ overflow:visible; }
</style>

<script type="module">
/* supabase client が既に window.supabase にあることを前提。
   もしない場合は最上部で createClient するコードを追加してください。 */

const TARGET_ORIGIN = location.origin || '*'

// utility: send message to parent
function postToParent(msg){
  try{ window.parent.postMessage(msg, TARGET_ORIGIN) }catch(e){ try{ window.parent.postMessage(msg, '*') }catch(e2){ console.warn('postToParent failed', e2) } }
}

function reportReady(){ postToParent({ type: 'child_ready', url: location.href }); console.log('embed: child_ready sent') }

if(typeof window.loadRemoteFor !== 'function'){
  window.loadRemoteFor = async function(uid){ console.log('loadRemoteFor not implemented - uid:', uid) }
}

window.addEventListener('message', async (ev) => {
  try{ if(ev.origin !== location.origin){ console.warn('embed: message origin mismatch', ev.origin, 'expected', location.origin) } }catch(e){ console.warn(e) }
  const msg = ev.data
  if(!msg || typeof msg !== 'object') return
  if(msg.type === 'supabase_session' && msg.session){
    console.log('embed: received session from host')
    try{
      if(window.supabase && typeof window.supabase.auth?.setSession === 'function'){
        await window.supabase.auth.setSession({ access_token: msg.session.access_token, refresh_token: msg.session.refresh_token })
        console.log('embed: supabase session set')
        const uid = msg.session.user?.id
        if(uid && typeof window.loadRemoteFor === 'function'){
          try{ await window.loadRemoteFor(uid); console.log('embed: loaded remote data for', uid) }catch(e){ console.warn('embed loadRemoteFor error', e) }
        }
      } else { console.warn('embed: supabase client or setSession not available') }
    }catch(e){ console.warn('embed setSession error', e) }
  } else if(msg.type === 'signout'){
    if(window.supabase && typeof window.supabase.auth?.signOut === 'function'){
      try{ await window.supabase.auth.signOut(); console.log('embed: signed out'); }catch(e){ console.warn(e) }
    }
  }
})

// HEIGHT reporting
function reportHeightToParent(){
  try{
    const body = document.body, html = document.documentElement
    const height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight)
    postToParent({ type:'child_height', height })
  }catch(e){ console.warn('reportHeightToParent err', e) }
}

const ro = new ResizeObserver(entries => { reportHeightToParent() })
ro.observe(document.documentElement)
ro.observe(document.body)

const mo = new MutationObserver(() => { setTimeout(reportHeightToParent, 40) })
mo.observe(document.body, { childList:true, subtree:true, attributes:true })

window.addEventListener('load', ()=>{ reportReady(); setTimeout(reportHeightToParent, 120) })
setTimeout(reportReady, 300)
window.reportHeightToParent = reportHeightToParent
window.postLogToParent = msg => postToParent({ type:'child_log', msg })

</script>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>学習実態調査（認証付き・修正版）</title>
<style>
:root{ --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#4461f2; --radius:12px; }
*{box-sizing:border-box}
body{font-family:Inter,system-ui,'Noto Sans JP',sans-serif;background:var(--bg);margin:18px;color:#0f1724}
.wrap{max-width:1100px;margin:0 auto}
.card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 10px 30px rgba(16,24,40,0.06)}
.top{display:flex;gap:12px;align-items:flex-start;margin-bottom:12px}
.small{font-size:13px;color:var(--muted)}
.palette{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.subject-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;color:#fff;font-weight:700;cursor:pointer;border:0}
.grid-wrap{overflow:auto;margin-top:12px}
.hours-grid{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(72px,1fr);padding:12px}
.hour-col{min-width:72px;padding:6px}
.hour-header{font-size:12px;color:var(--muted);text-align:center;margin-bottom:6px}
.hour-cell{height:72px;border-radius:10px;border:1px solid rgba(16,24,40,0.04);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff,#fbfbff)}
.segments{display:flex;height:100%;width:100%}
.segment{flex:1;position:relative}
.fill{position:absolute;left:0;top:0;bottom:0;width:0;transition:width .2s linear}
.overlay{position:absolute;left:0;right:0;bottom:6px;text-align:center;font-weight:700;color:rgba(0,0,0,0.65);z-index:3}
.cell-label{position:absolute;left:6px;top:6px;font-weight:700;color:rgba(0,0,0,0.75);z-index:4}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
.legend .item{display:flex;align-items:center;gap:8px}
.legend input[type="color"]{border:0;padding:0;width:34px;height:28px;border-radius:6px}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(68,97,242,0.12)}
.auth-card{min-width:260px;display:flex;flex-direction:column;gap:8px}
.compact-day{background:#fff;border-radius:10px;padding:8px;border:1px solid rgba(0,0,0,0.04);margin-top:8px}
.compact-grid{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(48px,1fr);gap:6px;align-items:start}
.compact-hour{min-width:48px}
.compact-cell{height:44px;border-radius:8px;border:1px solid rgba(16,24,40,0.04);position:relative;overflow:hidden}
.small-muted{font-size:12px;color:var(--muted)}
.add-subject{display:flex;gap:8px;margin-top:8px;align-items:center}
.graph-card{margin-top:10px}
.overlay-list{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.36);display:flex;align-items:center;justify-content:center}
.overlay-card{background:white;padding:12px;border-radius:12px;max-width:760px;width:100%;max-height:80vh;overflow:auto}
@media(max-width:900px){.hour-cell{height:56px}}
</style>
</head>
<body>
<div class="wrap">
  <h1>デジタル版学習実態調査</h1>

  <div class="top">
    <div class="card" style="min-width:480px">
      <div style="display:flex;gap:12px;align-items:center">
        <div><div class="small">日付</div><input type="date" id="dateInput"></div>
        <div><div class="small">開始時刻</div><input type="time" id="startTimeInput"></div>
        <div style="margin-left:8px"><div class="small">操作</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="startBtn" class="btn">開始</button>
            <button id="pauseBtn" class="btn ghost">一時停止</button>
            <button id="resetBtn" class="btn ghost">リセット</button>
            <button id="setNowBtn" class="btn ghost">今に</button>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:16px;margin-top:10px;align-items:center">
        <div class="small">経過（セッション）<div id="elapsedLabel" style="font-weight:800">00:00:00</div></div>
        <div class="small">今日合計<div id="todayTotalLabel" style="font-weight:800">0:00:00</div></div>
      </div>
    </div>

    <div style="flex:1"></div>

    <div class="card auth-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">アカウント</div>
        <div id="authControls"></div>
      </div>
      <div id="authStatus" class="small-muted">状態: 未確認</div>
      <div class="small-muted" style="margin-top:6px">※サインアップ時に役割（teacher / student）を指定</div>
    </div>

    <div class="card" style="min-width:360px">
      <div class="small">教科パレット（選択してから開始）</div>
      <div id="palette" class="palette"></div>
      <div id="legend" class="legend"></div>

      <div class="add-subject">
        <input id="newSubjectName" placeholder="新しい教科名" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb;flex:1" />
        <input id="newSubjectColor" type="color" value="#7c3aed" />
        <button id="addSubjectBtn" class="btn">追加</button>
      </div>

      <div class="small" style="margin-top:8px">直近1週間</div>
      <div id="weeklyList" class="small" style="margin-top:6px"></div>
      <div id="weeklyTotalBox" style="display:none;margin-top:8px" class="small"><strong>週合計:</strong> <span id="weeklyTotalLabel">0:00:00</span></div>

      <div id="openedDays"></div>

      <div class="card graph-card" style="margin-top:10px;padding:10px">
        <div class="small">日別合計（折れ線）</div>
        <div id="weeklyChart" style="width:100%;height:160px;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="small">時間表示と塗り</div>
    <div class="grid-wrap"><div id="hoursGrid" class="hours-grid"></div></div>
  </div>
</div>

<!-- 学生選択オーバーレイ（先生用） -->
<div id="studentOverlay" style="display:none" class="overlay-list">
  <div class="overlay-card card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>生徒一覧</strong><button id="closeStudentOverlay" class="btn ghost">閉じる</button></div>
    <div id="studentListArea">読み込み中…</div>
  </div>
</div>

<script type="module">
/* --------------------------
   Supabase setup
   -------------------------- */
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
window.supabase = supabase

/* --------------------------
   Constants & state
   -------------------------- */
const SEG_MIN = 5, SEG_MS = SEG_MIN * 60000, SEG_H = 60 / SEG_MIN
const STORAGE = 'studio_v4'
const SESSION_KEY = 'supabase_session_v2'
let state = { hourSegments: {}, colors: {}, timer: { running:false, sessionAccumulatedMs:0, _lastTick:null }, _user_saved:false }
let SUBJECTS = [
  { key:'jp', name:'国語', color:'#FF6B6B' },
  { key:'math', name:'数学', color:'#4D9FEE' },
  { key:'sci', name:'理科', color:'#47C88E' },
  { key:'soc', name:'社会', color:'#F6C85F' },
  { key:'en', name:'英語', color:'#9B7BFF' },
]
let sel = SUBJECTS[0].key
let selectedDays = new Set()

/* --------------------------
   DOM refs
   -------------------------- */
const dateInput = document.getElementById('dateInput')
const startTimeInput = document.getElementById('startTimeInput')
const startBtn = document.getElementById('startBtn'), pauseBtn = document.getElementById('pauseBtn'), resetBtn = document.getElementById('resetBtn'), setNowBtn = document.getElementById('setNowBtn')
const hoursGrid = document.getElementById('hoursGrid'), palette = document.getElementById('palette'), legend = document.getElementById('legend')
const elapsedLabel = document.getElementById('elapsedLabel'), todayTotalLabel = document.getElementById('todayTotalLabel')
const authControls = document.getElementById('authControls'), authStatus = document.getElementById('authStatus')
const weeklyList = document.getElementById('weeklyList'), weeklyTotalBox = document.getElementById('weeklyTotalBox'), weeklyTotalLabel = document.getElementById('weeklyTotalLabel')
const openedDays = document.getElementById('openedDays')
const addSubjectBtn = document.getElementById('addSubjectBtn'), newSubjectName = document.getElementById('newSubjectName'), newSubjectColor = document.getElementById('newSubjectColor')
const weeklyChartTarget = document.getElementById('weeklyChart')
const studentOverlay = document.getElementById('studentOverlay'), studentListArea = document.getElementById('studentListArea'), closeStudentOverlay = document.getElementById('closeStudentOverlay')

/* --------------------------
   Local load/save
   -------------------------- */
function loadLocal(){
  try{ const raw = localStorage.getItem(STORAGE); if(raw){ const parsed = JSON.parse(raw); state = Object.assign({}, state, parsed) } }catch(e){ console.warn('loadLocal', e) }
  SUBJECTS.forEach(s => { if(!state.colors[s.key]) state.colors[s.key] = s.color })
}
function saveLocal(){ try{ localStorage.setItem(STORAGE, JSON.stringify(state)) }catch(e){ console.warn('saveLocal', e) } }

/* --------------------------
   Session persistence helpers
   -------------------------- */
function saveSessionLocal(session){ try{ if(!session){ localStorage.removeItem(SESSION_KEY); return } const slim = { access_token: session.access_token, refresh_token: session.refresh_token, user: session.user }; localStorage.setItem(SESSION_KEY, JSON.stringify(slim)) }catch(e){ console.warn('saveSessionLocal', e) }
}
async function restoreSessionLocalIfNeeded(){
  try{
    const { data } = await supabase.auth.getSession()
    if(data?.session) return
    const raw = localStorage.getItem(SESSION_KEY)
    if(!raw) return
    const saved = JSON.parse(raw)
    if(saved?.access_token && saved?.refresh_token){
      const { data: setData, error } = await supabase.auth.setSession({ access_token: saved.access_token, refresh_token: saved.refresh_token })
      if(error){ console.warn('setSession error', error); localStorage.removeItem(SESSION_KEY) }
      else console.log('session restored from local')
    }
  }catch(e){ console.warn('restoreSessionLocalIfNeeded', e) }
}
function clearSavedSession(){ try{ localStorage.removeItem(SESSION_KEY) }catch(e){ console.warn(e) } }

/* subscribe auth changes */
supabase.auth.onAuthStateChange(async (event, session) => {
  if(session?.access_token) saveSessionLocal(session)
  else clearSavedSession()

  if(session?.user){
    const role = await fetchRoleForUser(session.user.id)
    renderAuthUI(session.user.email, role)
    authStatus.textContent = `ログイン: ${session.user.email}（${role||'未設定'}）`
    await loadRemoteFor(session.user.id)
  } else {
    renderAuthUI(null)
    authStatus.textContent = '未ログイン（ローカル保存）'
  }
})

/* --------------------------
   helpers
   -------------------------- */
const fmt = ms => { if(!ms) return '0:00:00'; let s = Math.floor(ms/1000), h = Math.floor(s/3600); s = s % 3600; const m = Math.floor(s/60), sec = s%60; return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}` }
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
const todayY = ()=> ymd(new Date())
const timeIn = d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`
function ensureDay(dayStr){ if(!state.hourSegments[dayStr]) state.hourSegments[dayStr] = Array.from({length:24}, ()=> Array.from({length:SEG_H}, ()=> ({subject:'', filledMs:0}))) }
function shade(hex, percent){ const h = hex.replace('#',''); const r = parseInt(h.substring(0,2),16); const g = parseInt(h.substring(2,4),16); const b = parseInt(h.substring(4,6),16); const t = percent < 0 ? 0 : 255; const p = Math.abs(percent)/100; const R = Math.round((t-r)*p)+r; const G = Math.round((t-g)*p)+g; const B = Math.round((t-b)*p)+b; return `rgb(${R}, ${G}, ${B})` }

/* --------------------------
   Palette & subjects
   -------------------------- */
function buildPalette(){
  palette.innerHTML = ''
  legend.innerHTML = ''
  SUBJECTS.forEach((s, idx) => {
    if(!state.colors[s.key]) state.colors[s.key] = s.color
    const btn = document.createElement('button')
    btn.className = 'subject-btn'; btn.dataset.key = s.key; btn.style.background = state.colors[s.key]
    btn.innerHTML = `<div style="width:14px;height:14px;border-radius:50%;background:${shade(state.colors[s.key],-8)}"></div><div>${s.name}</div>`
    btn.addEventListener('click', ()=>{ sel = s.key; highlightSelected() })
    palette.appendChild(btn)
    const item = document.createElement('div'); item.className='item'
    item.style.display='flex'; item.style.alignItems='center'; item.style.gap='8px'
    const sw = document.createElement('div'); sw.style.width='18px'; sw.style.height='12px'; sw.style.borderRadius='6px'; sw.style.background=state.colors[s.key]
    const lab = document.createElement('div'); lab.textContent = s.name
    const colorInp = document.createElement('input'); colorInp.type='color'; colorInp.value = state.colors[s.key]
    colorInp.addEventListener('input', (e)=>{ state.colors[s.key] = e.target.value; saveLocal(); rebuildColors(); renderAll() })
    item.appendChild(sw); item.appendChild(lab); item.appendChild(colorInp)
    legend.appendChild(item)
  })
  highlightSelected()
}
function rebuildColors(){
  palette.querySelectorAll('.subject-btn').forEach(b=>{ const k = b.dataset.key; b.style.background = state.colors[k]; const dot = b.querySelector('div'); if(dot) dot.style.background = shade(state.colors[k], -8) })
  Array.from(legend.querySelectorAll('.item')).forEach((it, idx)=>{ const sw = it.querySelector('div'); if(sw && SUBJECTS[idx]) sw.style.background = state.colors[SUBJECTS[idx].key]; const colorInp = it.querySelector('input[type="color"]'); if(colorInp && SUBJECTS[idx]) colorInp.value = state.colors[SUBJECTS[idx].key] })
}
function highlightSelected(){ palette.querySelectorAll('.subject-btn').forEach(b=>{ if(b.dataset.key === sel) b.style.boxShadow = '0 6px 20px rgba(2,6,23,0.12)'; else b.style.boxShadow = 'none' }) }
addSubjectBtn.addEventListener('click', ()=>{ const name = (newSubjectName.value||'').trim(); const color = newSubjectColor.value || '#7c3aed'; if(!name) return alert('教科名を入力してください'); let key = name.toLowerCase().replace(/[^\w]+/g,'_'); let base = key, suffix = 1; while(SUBJECTS.some(s=>s.key === key)){ key = base + '_' + (suffix++) } const subj = { key, name, color }; SUBJECTS.push(subj); state.colors[key] = color; newSubjectName.value = ''; buildPalette(); saveLocal() })

/* --------------------------
   Grid / render
   -------------------------- */
function buildGrid(){ hoursGrid.innerHTML = ''
  for(let h=0; h<24; h++){
    const col = document.createElement('div'); col.className='hour-col'; col.dataset.hour = h
    const header = document.createElement('div'); header.className='hour-header'; header.textContent = `${h}:00`
    const cell = document.createElement('div'); cell.className='hour-cell'; cell.addEventListener('click', ()=> onHourClick(h))
    col.appendChild(header); col.appendChild(cell); hoursGrid.appendChild(col)
  }
}
function renderCell(dateStr, hour){ ensureDay(dateStr); const segs = state.hourSegments[dateStr][hour]; const col = hoursGrid.querySelector(`.hour-col[data-hour='${hour}']`); if(!col) return; const cell = col.querySelector('.hour-cell'); cell.innerHTML = ''; const wrap = document.createElement('div'); wrap.className='segments'
  for(let i=0;i<SEG_H;i++){ const s = segs[i]; const segDiv = document.createElement('div'); segDiv.className='segment'; const fill = document.createElement('div'); fill.className='fill'; const pct = Math.max(0, Math.min(1, (s.filledMs||0)/SEG_MS)); fill.style.width = (pct*100) + '%'; if(s.subject && state.colors[s.subject]) fill.style.background = `linear-gradient(90deg, ${state.colors[s.subject]}, ${shade(state.colors[s.subject],-8)})`; segDiv.appendChild(fill); wrap.appendChild(segDiv) }
  const label = document.createElement('div'); label.className='cell-label'; const allSubjs = new Set(segs.map(s=>s.subject||'')); if(allSubjs.size === 1 && !allSubjs.has('')) label.textContent = SUBJECTS.find(x=>x.key===segs[0].subject)?.name || ''
  const overlay = document.createElement('div'); overlay.className='overlay'; const totalFilled = segs.reduce((a,b)=>a+(b.filledMs||0),0); overlay.textContent = (totalFilled >= 3600000) ? '完了' : ''
  cell.appendChild(wrap); cell.appendChild(label); cell.appendChild(overlay)
}
function renderAll(){ if(!dateInput.value) dateInput.value = todayY(); const dateStr = dateInput.value; ensureDay(dateStr); sanitizeFutureSegments(dateStr); for(let h=0; h<24; h++) renderCell(dateStr,h); renderTotals(); updateButtonStyles(); saveLocal() }
function onHourClick(hour){ const dateStr = dateInput.value; ensureDay(dateStr); const segs = state.hourSegments[dateStr][hour]; let changed = false; for(let i=0;i<SEG_H;i++){ if(segs[i].filledMs === 0 && segs[i].subject !== sel){ segs[i].subject = sel; changed = true } } if(changed){ scheduleSave(); renderAll() } }

/* --------------------------
   Timer
   -------------------------- */
function getSegmentStartMs(ts){ const d = new Date(ts); const dayStart = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); const minutesSinceDay = Math.floor((ts - dayStart)/60000); const segIndexOverall = Math.floor(minutesSinceDay / SEG_MIN); return dayStart + segIndexOverall * SEG_MS }
function allocateDelta(prevMs, nowMs){ if(nowMs <= prevMs) return; let cur = prevMs; const subject = sel; while(cur < nowMs){ const segStart = getSegmentStartMs(cur); const segEnd = segStart + SEG_MS; const addAvailable = Math.min(segEnd, nowMs) - cur; const d = new Date(segStart); const dateStr = ymd(d); const hour = d.getHours(); const minutesSinceHour = Math.floor((segStart - new Date(d.getFullYear(), d.getMonth(), d.getDate(), hour).getTime())/60000); const segIndex = Math.floor(minutesSinceHour / SEG_MIN); ensureDay(dateStr); const seg = state.hourSegments[dateStr][hour][segIndex]; const before = seg.filledMs || 0; const canAdd = Math.min(SEG_MS - before, addAvailable); if(canAdd > 0){ if(!seg.subject) seg.subject = subject; seg.filledMs = before + canAdd; state.timer.sessionAccumulatedMs = (state.timer.sessionAccumulatedMs || 0) + canAdd; cur += canAdd } else { cur = segEnd } } }
function tick(){ const now = Date.now(); const prev = state.timer._lastTick || now; allocateDelta(prev, now); state.timer._lastTick = now; updateElapsedDisplay(); renderAll(); scheduleSave() }
function updateElapsedDisplay(){ elapsedLabel.textContent = fmt(state.timer.sessionAccumulatedMs || 0); const dateStr = dateInput.value; ensureDay(dateStr); const todayMs = state.hourSegments[dateStr].reduce((a,h)=>a + h.reduce((aa,seg)=>aa + (seg.filledMs||0),0),0); todayTotalLabel.textContent = fmt(todayMs) }
function startTimer(){ if(state.timer.running) return; state.timer.running = true; state.timer._lastTick = Date.now(); window._tickI = setInterval(tick, 1000); updateButtonStyles(); saveLocal() }
// HTMLファイル内の pauseTimer() 関数を以下に置き換えてください

// embed4.htmlの pauseTimer 関数を以下に置き換えてください
// （357行目あたり）

async function pauseTimer(){
    if(!state.timer.running) return;

    tick();
    state.timer.running = false;
    clearInterval(window._tickI);

    const studyTimeMs = state.timer.sessionAccumulatedMs || 0;
    const studentId = getCurrentUserId(); 
    
    console.log('=== pauseTimer デバッグ情報 ===');
    console.log('勉強時間(ms):', studyTimeMs);
    console.log('生徒ID:', studentId);
    console.log('送信可否:', studyTimeMs > 0 && studentId);
    
    if (studyTimeMs > 0 && studentId) {
        console.log('✅ Supabaseへ学習記録を保存中...');
        try {
            await saveStudyRecordToSupabase(studentId, studyTimeMs);
        } catch(e) {
            console.error('❌ 保存関数呼び出しエラー:', e);
        }
    } else {
        console.warn('⚠️ データ送信スキップ');
    }

    state.timer.sessionAccumulatedMs = 0;
    state.timer._lastTick = null;
    updateElapsedDisplay();
    updateButtonStyles();
    saveLocal();
    scheduleSave();
    renderAll();
    console.log('=== pauseTimer 完了 ===');
}
function resetTimer(){ if(!confirm('タイマーをリセットします（セッション累積は0に戻ります）。よろしいですか？')) return; state.timer.running = false; clearInterval(window._tickI); state.timer._lastTick = null; state.timer.sessionAccumulatedMs = 0; updateElapsedDisplay(); updateButtonStyles(); saveLocal(); renderAll() }
function onSetNow(){ startTimeInput.value = timeIn(new Date()) }
function updateButtonStyles(){ if(state.timer.running){ startBtn.textContent = '停止'; startBtn.classList.add('running') } else { startBtn.textContent = '開始'; startBtn.classList.remove('running') } }

/* --------------------------
   Totals / weekly / graph
   -------------------------- */
function lastNDates(endDateStr, n){ const [y,m,d] = endDateStr.split('-').map(x=>parseInt(x,10)); const end = new Date(y, m-1, d); const arr=[]; for(let i=n-1;i>=0;i--){ const dd = new Date(end); dd.setDate(end.getDate()-i); arr.push(ymd(dd)) } return arr }
function weekdayName(dateStr){ const d = new Date(dateStr); return ['日','月','火','水','木','金','土'][d.getDay()] }

function renderTotals(){ const dateStr = dateInput.value; ensureDay(dateStr); const todayMs = state.hourSegments[dateStr].reduce((a,h)=>a + h.reduce((aa,seg)=>aa + (seg.filledMs||0),0),0); todayTotalLabel.textContent = fmt(todayMs)
  const days = lastNDates(dateStr, 7); weeklyList.innerHTML = ''; let weeklyTotalMs = 0; days.forEach(d=>{ ensureDay(d); const total = state.hourSegments[d].reduce((a,h)=>a + h.reduce((aa,seg)=>aa + (seg.filledMs||0),0),0); weeklyTotalMs += total; const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px'; div.style.borderRadius='8px'; div.style.background='#fbfbff'; div.style.cursor='pointer'; div.style.marginBottom='6px'; const left = document.createElement('div'); left.textContent = `${d} (${weekdayName(d)})`; const right = document.createElement('div'); right.textContent = fmt(total); div.appendChild(left); div.appendChild(right); div.addEventListener('click', ()=>{ toggleDay(d, div) }); if(selectedDays.has(d)) div.style.boxShadow='0 6px 18px rgba(66,97,242,0.04)'; weeklyList.appendChild(div) })
  if(weeklyTotalMs > 0){ weeklyTotalBox.style.display='block'; weeklyTotalLabel.textContent = fmt(weeklyTotalMs) } else { weeklyTotalBox.style.display='none' }
  renderSelected(); renderWeeklyChart()
}

function toggleDay(d, el){ if(selectedDays.has(d)){ selectedDays.delete(d); el.style.boxShadow='none' } else { selectedDays.add(d); el.style.boxShadow='0 6px 18px rgba(66,97,242,0.04)' } renderSelected() }
function renderSelected(){ openedDays.innerHTML = ''; if(selectedDays.size === 0) return; selectedDays.forEach(d=>{ ensureDay(d); const panel = document.createElement('div'); panel.className='compact-day'; const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.style.marginBottom='8px'; const title = document.createElement('div'); title.innerHTML = `<strong>${d} (${weekdayName(d)})</strong>`; const closeBtn = document.createElement('button'); closeBtn.className='btn ghost'; closeBtn.style.fontSize='12px'; closeBtn.textContent='閉じる'; closeBtn.onclick = ()=>{ selectedDays.delete(d); renderSelected(); renderTotals() }; header.appendChild(title); header.appendChild(closeBtn); panel.appendChild(header); const grid = document.createElement('div'); grid.className='compact-grid'
    for(let h=0; h<24; h++){ const hourCol = document.createElement('div'); hourCol.className='compact-hour'; const hh = document.createElement('div'); hh.className='hour-header'; hh.style.fontSize='12px'; hh.style.marginBottom='6px'; hh.textContent = `${h}:00`; const cell = document.createElement('div'); cell.className='compact-cell'; const segWrap = document.createElement('div'); segWrap.style.display='flex'; segWrap.style.height='100%'; segWrap.style.setProperty('--seg-count', SEG_H); const segs = state.hourSegments[d][h]; for(let i=0;i<SEG_H;i++){ const s = segs[i]; const segDiv = document.createElement('div'); segDiv.style.flex='0 0 calc(100% / '+SEG_H+')'; segDiv.style.position='relative'; const fill = document.createElement('div'); fill.style.height='100%'; const pct = Math.max(0, Math.min(1, (s.filledMs||0)/SEG_MS)); if(s.subject && state.colors[s.subject]) fill.style.background = `linear-gradient(90deg, ${state.colors[s.subject]}, ${shade(state.colors[s.subject],-8)})`; else fill.style.background = 'transparent'; fill.style.width = (pct*100) + '%'; fill.style.transition='width .2s linear'; segDiv.appendChild(fill); segWrap.appendChild(segDiv) } cell.appendChild(segWrap); hourCol.appendChild(hh); hourCol.appendChild(cell); grid.appendChild(hourCol) }
    panel.appendChild(grid); openedDays.appendChild(panel)
  }) }

/* --------------------------
   Remote persistence (Supabase)
   -------------------------- */
async function saveRemote(){
  try{
    const { data } = await supabase.auth.getSession()
    const session = data?.session
    if(!session || !session.user) return
    const payload = { user_id: session.user.id, data: state.hourSegments }
    // upsert on user_id to avoid duplicates
    const { error } = await supabase.from('user_hours').upsert(payload, { onConflict: ['user_id'] })
    if(error) console.warn('saveRemote err', error)
    else state._user_saved = true
  }catch(e){ console.warn('saveRemote', e) }
}
let saveTimer = null
function scheduleSave(){ if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(()=>{ saveLocal(); saveRemote() }, 900) }

async function loadRemoteFor(uid){
  try{
    const { data, error } = await supabase.from('user_hours').select('data').eq('user_id', uid).maybeSingle()
    if(error){ console.warn('loadRemoteFor error', error); return }
    if(data && data.data){ state.hourSegments = data.data; saveLocal(); renderAll(); state._user_saved = true }
    else { console.log('no remote data for', uid) }
  }catch(e){ console.warn('loadRemoteFor', e) }
}

/* --------------------------
   Auth UI & flows
   -------------------------- */
function renderAuthUI(email, role){
  authControls.innerHTML = ''
  if(!email){
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='メールでログイン/登録'; btn.onclick = openEmail; authControls.appendChild(btn)
  } else {
    const t = document.createElement('div'); t.style.fontWeight='700'; t.textContent = email
    const out = document.createElement('button'); out.className='btn ghost'; out.textContent='サインアウト'; out.onclick = signOut
    authControls.appendChild(t); authControls.appendChild(out)
    if(role === 'teacher'){
      const a = document.createElement('button'); a.className='btn'; a.textContent='先生メニュー'; a.onclick = openTeacherMenu; authControls.appendChild(a)
    }
  }
}

async function openEmail(){
  const mode = prompt('signup or signin? (例: signup)')
  if(!mode) return
  const email = prompt('メールアドレス')
  if(!email) return alert('メール未入力')
  const password = prompt('パスワード（8文字以上）')
  if(!password) return alert('パスワード未入力')
  if(mode === 'signup'){
    const role = prompt('role (teacher or student)','student') || 'student'
    const { data, error } = await supabase.auth.signUp({ email, password })
    if(error){ alert('登録エラー: ' + error.message); return }
    if(data?.user?.id){
      // store role and email in user_profiles so teacher can lookup students
      await supabase.from('user_profiles').upsert({ user_id: data.user.id, role, email }, { onConflict: ['user_id'] })
    }
    const { data: sessData } = await supabase.auth.getSession()
    if(sessData?.session){ saveSessionLocal(sessData.session); renderAuthUI(sessData.session.user.email, role); authStatus.textContent = `ログイン: ${sessData.session.user.email}`; await loadRemoteFor(sessData.session.user.id) }
    else alert('登録しました。確認メールを確認してください（必要があれば）。')
  } else {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password })
    if(error){ alert('サインイン失敗: ' + error.message); return }
    const session = data?.session
    if(session){
      saveSessionLocal(session)
      const uid = session.user.id
      const rp = await supabase.from('user_profiles').select('role,email').eq('user_id', uid).maybeSingle()
      const role = rp.data?.role || null
      renderAuthUI(session.user.email, role)
      authStatus.textContent = 'ログイン:' + session.user.email
      await loadRemoteFor(uid)
    } else {
      const { data: g } = await supabase.auth.getSession()
      const s = g?.session
      if(s){ saveSessionLocal(s); const uid = s.user.id; const rp = await supabase.from('user_profiles').select('role,email').eq('user_id', uid).maybeSingle(); const role = rp.data?.role||null; renderAuthUI(s.user.email,role); authStatus.textContent='ログイン:'+s.user.email; await loadRemoteFor(uid) }
    }
  }
}

async function signOut(){ try{ await supabase.auth.signOut() }catch(e){ console.warn(e) } clearSavedSession(); renderAuthUI(null); authStatus.textContent = 'サインアウト' }

async function fetchRoleForUser(userId){ try{ const { data, error } = await supabase.from('user_profiles').select('role').eq('user_id', userId).maybeSingle(); if(error){ console.warn('role fetch', error); return null } return data?.role || null }catch(e){ console.error(e); return null } }

/* --------------------------
   Teacher helpers: fetch student list & load
   -------------------------- */
async function openTeacherMenu(){
  studentOverlay.style.display = 'flex'
  studentListArea.innerHTML = '取得中…'
  try{
    const { data, error } = await supabase.from('user_profiles').select('user_id,email,role').eq('role','student')
    if(error){ studentListArea.innerHTML = '生徒一覧取得エラー'; console.warn(error); return }
    if(!data || data.length === 0){ studentListArea.innerHTML = '生徒データが登録されていません' }
    else {
      const list = document.createElement('div')
      data.forEach(p=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.borderBottom='1px solid rgba(0,0,0,0.04)'
        const left = document.createElement('div'); left.textContent = p.email ? `${p.email} (${p.user_id.slice(0,6)})` : p.user_id
        const loadBtn = document.createElement('button'); loadBtn.className = 'btn ghost'; loadBtn.textContent = '読み込む'; loadBtn.onclick = async ()=>{ await loadRemoteFor(p.user_id); studentOverlay.style.display='none' }
        row.appendChild(left); row.appendChild(loadBtn); list.appendChild(row)
      })
      studentListArea.innerHTML = ''
      studentListArea.appendChild(list)
    }
  }catch(e){ studentListArea.innerHTML = '生徒一覧取得例外'; console.warn(e) }
}
closeStudentOverlay.addEventListener('click', ()=> studentOverlay.style.display='none')

/* --------------------------
   Weekly chart
   -------------------------- */
function renderWeeklyChart(){
  const chartDiv = document.getElementById('weeklyChart'); if(!chartDiv) return; if(!chartDiv.style.height || chartDiv.style.height === '') chartDiv.style.height = '160px'; chartDiv.innerHTML = ''
  const days = lastNDates(dateInput.value || todayY(), 7);
  const totals = days.map(d => { if(!state.hourSegments[d]) return 0; return state.hourSegments[d].reduce((a,h)=>a+h.reduce((aa,s)=>aa + (s.filledMs||0),0),0) / 3600000 });
  const containerW = chartDiv.clientWidth; const containerH = chartDiv.clientHeight || 160; if(containerW === 0){ requestAnimationFrame(()=>{ renderWeeklyChart(); }); return; }
  const margin = { top: 20, right: 12, bottom: 28, left: 12 }; const w = containerW; const h = containerH; const innerW = Math.max(10, w - margin.left - margin.right); const innerH = Math.max(10, h - margin.top - margin.bottom);
  const svgNS = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.setAttribute('preserveAspectRatio', 'xMidYMid meet'); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%'); svg.style.display = 'block'; svg.innerHTML = ''
  for(let i=0;i<=4;i++){ const ly = margin.top + i * (innerH / 4); const line = document.createElementNS(svgNS,'line'); line.setAttribute('x1', margin.left); line.setAttribute('x2', margin.left + innerW); line.setAttribute('y1', ly); line.setAttribute('y2', ly); line.setAttribute('stroke', 'rgba(15,23,36,0.04)'); line.setAttribute('stroke-width', '1'); svg.appendChild(line) }
  const n = totals.length; const stepX = n > 1 ? innerW / (n-1) : innerW; const maxTotal = Math.max(...totals, 1); const points = totals.map((t,i)=>{ const x = Math.round(margin.left + i * stepX); const y = Math.round(margin.top + (1 - (t / maxTotal)) * innerH); return [x,y]; });
  const path = document.createElementNS(svgNS,'path'); const d = points.map((p,i)=> i===0?`M${p[0]} ${p[1]}`:`L${p[0]} ${p[1]}`).join(' '); path.setAttribute('d', d); path.setAttribute('fill', 'none'); path.setAttribute('stroke', '#4461f2'); path.setAttribute('stroke-width', '3'); path.setAttribute('stroke-linejoin', 'round'); path.setAttribute('stroke-linecap', 'round'); svg.appendChild(path)
  try{ const area = document.createElementNS(svgNS,'path'); const areaD = `${d} L ${margin.left + innerW} ${margin.top + innerH} L ${margin.left} ${margin.top + innerH} Z`; area.setAttribute('d', areaD); area.setAttribute('fill', 'rgba(68,97,242,0.06)'); svg.insertBefore(area, path) }catch(e){}
  points.forEach((p,i)=>{ const circ = document.createElementNS(svgNS,'circle'); circ.setAttribute('cx', p[0]); circ.setAttribute('cy', p[1]); circ.setAttribute('r', 4); circ.setAttribute('fill', '#4461f2'); svg.appendChild(circ); const tx = document.createElementNS(svgNS,'text'); tx.setAttribute('x', p[0]); tx.setAttribute('y', h - 6); tx.setAttribute('text-anchor','middle'); tx.setAttribute('font-size','11'); tx.setAttribute('fill','#0f1724'); tx.textContent = days[i].slice(5); svg.appendChild(tx); const vl = document.createElementNS(svgNS,'text'); vl.setAttribute('x', p[0]); vl.setAttribute('y', p[1] - 8); vl.setAttribute('text-anchor','middle'); vl.setAttribute('font-size','11'); vl.setAttribute('fill','#0f1724'); vl.textContent = totals[i].toFixed(1) + 'h'; svg.appendChild(vl) })
  chartDiv.appendChild(svg); setTimeout(()=>{ reportHeightToParent() }, 60)
}

let _chartResizeObserver = null; let _chartResizeDebounce = null;
function observeWeeklyChartResize(){ const chartDiv = document.getElementById('weeklyChart'); if(!chartDiv) return; if(_chartResizeObserver) _chartResizeObserver.disconnect(); _chartResizeObserver = new ResizeObserver(entries=>{ if(_chartResizeDebounce) clearTimeout(_chartResizeDebounce); _chartResizeDebounce = setTimeout(()=>{ renderWeeklyChart(); }, 120); }); _chartResizeObserver.observe(chartDiv); window.addEventListener('resize', ()=>{ if(_chartResizeDebounce) clearTimeout(_chartResizeDebounce); _chartResizeDebounce = setTimeout(()=>renderWeeklyChart(), 120) }) }
if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', ()=>{ observeWeeklyChartResize(); renderWeeklyChart(); }); } else { observeWeeklyChartResize(); renderWeeklyChart(); }

function reportHeightToParent(){ try{ const body = document.body; const html = document.documentElement; const height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight); if(window.parent && window.parent !== window){ window.parent.postMessage({ type: 'child_height', height: height }, location.origin); } }catch(e){ console.warn(e) } }
new MutationObserver(()=>{ setTimeout(reportHeightToParent, 80) }).observe(document.body, { childList:true, subtree:true, attributes:true });

/* --------------------------
   sanitize future segments to avoid pre-filled "24h" bug
   -------------------------- */
function sanitizeFutureSegments(dateStr){
  // ensure all segments exist
  ensureDay(dateStr)
  try{
    const today = todayY()
    const now = Date.now()
    if(dateStr === today){
      // for today's date, any segment whose start time is in the future must be zeroed
      for(let h=0; h<24; h++){
        for(let si=0; si<SEG_H; si++){
          const segStart = new Date(dateStr + 'T00:00:00')
          segStart.setHours(h)
          segStart.setMinutes(si*SEG_MIN)
          if(segStart.getTime() > now){ state.hourSegments[dateStr][h][si].filledMs = 0 }
          // clamp to max SEG_MS
          if(state.hourSegments[dateStr][h][si].filledMs > SEG_MS) state.hourSegments[dateStr][h][si].filledMs = SEG_MS
        }
      }
    } else {
      // for past/future dates other than today, just clamp each segment to [0,SEG_MS]
      for(let h=0; h<24; h++){
        for(let si=0; si<SEG_H; si++){
          if(state.hourSegments[dateStr][h][si].filledMs > SEG_MS) state.hourSegments[dateStr][h][si].filledMs = SEG_MS
          if(state.hourSegments[dateStr][h][si].filledMs < 0) state.hourSegments[dateStr][h][si].filledMs = 0
        }
      }
    }
  }catch(e){ console.warn('sanitizeFutureSegments', e) }
}

/* --------------------------
   Init
   -------------------------- */
(async function init(){
  loadLocal()
  if(!dateInput.value) dateInput.value = todayY()
  if(!startTimeInput.value) startTimeInput.value = timeIn(new Date())
  buildPalette()
  buildGrid()
  renderAll()
  renderAuthUI(null)

  await restoreSessionLocalIfNeeded()

  try{
    const { data } = await supabase.auth.getSession()
    const session = data?.session
    if(session && session.user){
      const role = await fetchRoleForUser(session.user.id)
      renderAuthUI(session.user.email, role)
      authStatus.textContent = `ログイン: ${session.user.email}`
      await loadRemoteFor(session.user.id)
    } else {
      authStatus.textContent = '未ログイン（ローカル保存）'
    }
  }catch(e){ console.warn('session check', e); authStatus.textContent = '認証チェック失敗' }
})()

/* --------------------------
   Bindings
   -------------------------- */
startBtn.addEventListener('click', ()=> state.timer.running ? pauseTimer() : startTimer())
pauseBtn.addEventListener('click', pauseTimer)
resetBtn.addEventListener('click', resetTimer)
setNowBtn.addEventListener('click', onSetNow)
dateInput.addEventListener('change', ()=> renderAll())

/* End of script */
</script>
  <script>
// getCurrentUserId 関数
function getCurrentUserId() {
    try {
        const sessionData = localStorage.getItem('supabase_session_v2');
        if (!sessionData) {
            console.warn('⚠️ Supabaseセッションが見つかりません');
            return null;
        }
        
        const session = JSON.parse(sessionData);
        return session?.user?.id || null;
        
    } catch (e) {
        console.error("❌ Supabaseセッションから生徒IDの取得に失敗:", e);
        return null;
    }
}

// 学習記録をSupabaseに保存
async function saveStudyRecordToSupabase(userId, studyTimeMs) {
    try {
        const now = new Date();
        const dateStr = ymd(now);
        
        const { data, error } = await window.supabase
            .from('study_records')
            .insert([
                {
                    user_id: userId,
                    study_date: dateStr,
                    study_time_ms: studyTimeMs,
                    recorded_at: now.toISOString()
                }
            ]);
        
        if (error) {
            console.error('❌ Supabase保存エラー:', error);
        } else {
            console.log('✅ Supabase学習記録保存成功:', {
                date: dateStr,
                time: fmt(studyTimeMs)
            });
        }
    } catch (e) {
        console.error('❌ 学習記録保存例外:', e);
    }
}
</script>
</body>
</html>

