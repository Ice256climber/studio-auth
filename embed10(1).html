<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å­¦ç¿’å®Ÿæ…‹èª¿æŸ»</title>
<style>
:root{ --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#4461f2; --radius:12px; }
*{box-sizing:border-box}
body{font-family:Inter,system-ui,'Noto Sans JP',sans-serif;background:var(--bg);margin:18px;color:#0f1724}
.wrap{max-width:1400px;margin:0 auto}
.card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 10px 30px rgba(16,24,40,0.06);margin-bottom:12px}
.top{display:flex;gap:12px;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.palette{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.subject-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;color:#fff;font-weight:700;cursor:pointer;border:0;transition:all 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.subject-btn:hover{opacity:0.9;transform:translateY(-1px)}
.subject-btn.active{outline:3px solid var(--accent);outline-offset:3px}
.subject-icon{width:20px;height:20px;border-radius:50%;border:1px solid #fff;background:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;color:#0f1724}
.time-display{font-size:48px;font-weight:800;text-align:center;margin:20px 0;letter-spacing:-1px}
.buttons{display:flex;gap:12px;flex-wrap:wrap}
.buttons button{flex:1;padding:16px 20px;border-radius:var(--radius);font-size:16px;font-weight:700;cursor:pointer;border:0;transition:background 0.2s}
#startBtn{background:var(--accent);color:#fff}
#startBtn:hover{background:#354fb8}
#startBtn.running{background:#dc2626}
#startBtn.running:hover{background:#b91c1c}
#resetBtn{background:#f3f4f6;color:#0f1724}
#resetBtn:hover{background:#e5e7eb}
.date-section{display:flex;gap:8px;align-items:center;margin-top:12px}
.date-section label{font-size:14px;color:var(--muted);width:60px}
.date-section input[type="date"],.date-section input[type="time"]{padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;flex-grow:1}
.date-section button{padding:8px 12px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer}
.date-section button:hover{background:#e5e7eb}
.timer-status{font-size:14px;text-align:center;margin-top:12px;height:20px}
.log-card{margin-top:20px;padding:16px;background:#fff;border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,0.04);max-height:300px;overflow-y:auto}
.log-item{padding:8px 0;border-bottom:1px dashed #f3f4f6;display:flex;justify-content:space-between}
.log-item:last-child{border-bottom:none}
.log-time{font-weight:600;color:var(--accent)}
.log-subject{font-size:13px}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>

</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div>
        <h2 style="margin:0">å­¦ç¿’å†…å®¹</h2>
        <div class="small">å­¦ç¿’é–‹å§‹å‰ã«é¸æŠã—ã¦ãã ã•ã„</div>
        <div class="palette" id="subjectPalette">
          </div>
      </div>
      <div>
        <button id="authBtn" class="subject-btn" style="background:#0f172a">ğŸ”‘ ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
        <div class="small" id="userIdDisplay" style="margin-top:5px;text-align:right">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: æœªèªè¨¼</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="date-section">
      <label for="dateInput">æ—¥ä»˜</label>
      <input type="date" id="dateInput">
      <label for="startTimeInput">é–‹å§‹æ™‚åˆ»</label>
      <input type="time" id="startTimeInput">
      <button id="setNowBtn">ä»Š</button>
    </div>

    <div class="time-display" id="elapsedDisplay">00:00:00</div>
    <div class="timer-status" id="timerStatus">åœæ­¢ä¸­</div>
    
    <div class="buttons">
      <button id="startBtn">é–‹å§‹</button>
      <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div id="logCard" class="log-card" style="display:none;">
    <h3 style="margin:0 0 10px 0;font-size:16px">æœ¬æ—¥ã®è¨˜éŒ²</h3>
    <div id="dailyLog"></div>
  </div>
</div>

<script>
  // UMDç‰ˆã§èª­ã¿è¾¼ã¾ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰createClientã‚’å–å¾—
  const { createClient } = window.supabase

  const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  window.supabase = supabase // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã«å…¬é–‹

  // DOMè¦ç´ 
  const elapsedDisplay = document.getElementById('elapsedDisplay')
  const timerStatus = document.getElementById('timerStatus')
  const startBtn = document.getElementById('startBtn')
  const resetBtn = document.getElementById('resetBtn')
  const dateInput = document.getElementById('dateInput')
  const startTimeInput = document.getElementById('startTimeInput')
  const setNowBtn = document.getElementById('setNowBtn')
  const subjectPalette = document.getElementById('subjectPalette')
  const userIdDisplay = document.getElementById('userIdDisplay')
  const authBtn = document.getElementById('authBtn')
  const dailyLogEl = document.getElementById('dailyLog')
  const logCard = document.getElementById('logCard')

  // å®šæ•°
  const SUBJECTS = [
    { name: 'æ•°å­¦', color: '#4461f2', icon: 'M' },
    { name: 'è‹±èª', color: '#10b981', icon: 'E' },
    { name: 'å›½èª', color: '#f59e0b', icon: 'å›½' },
    { name: 'ç†ç§‘', color: '#ef4444', icon: 'ç†' },
    { name: 'ç¤¾ä¼š', color: '#8b5cf6', icon: 'ç¤¾' },
    { name: 'ãã®ä»–', color: '#6b7280', icon: 'ä»–' }
  ]
  const LOCAL_STORAGE_KEY = 'studio_timer_state'
  const TIME_THRESHOLD_MS = 1000 // 1ç§’æœªæº€ã¯ä¿å­˜ã—ãªã„

  // çŠ¶æ…‹ç®¡ç†
  const state = {
    timer: {
      running: false,
      startTime: null,
      sessionAccumulatedMs: 0,
      _lastTick: null
    },
    selectedSubject: SUBJECTS[0],
    user: null, // Supabase Auth user object
    dailyLog: [] // ãã®æ—¥ã®è¨˜éŒ²
  }

  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

  function fmt(ms) {
    const totalSeconds = Math.floor(ms / 1000)
    const hours = Math.floor(totalSeconds / 3600)
    const minutes = Math.floor((totalSeconds % 3600) / 60)
    const seconds = totalSeconds % 60
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
  }

  function timeIn(d) {
    return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`
  }

  function todayYMD() {
    const d = new Date()
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
  }

  // --- çŠ¶æ…‹ã®æ°¸ç¶šåŒ– ---

  function saveLocal() {
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
      timer: {
        running: state.timer.running,
        sessionAccumulatedMs: state.timer.sessionAccumulatedMs,
        // runningãŒtrueã®å ´åˆã®ã¿startTimeã¨_lastTickã‚’ä¿å­˜
        startTime: state.timer.running ? state.timer.startTime : null,
        _lastTick: state.timer.running ? state.timer._lastTick : null
      },
      selectedSubject: state.selectedSubject,
      date: dateInput.value,
      startTime: startTimeInput.value
    }))
  }

  function loadLocal() {
    const saved = localStorage.getItem(LOCAL_STORAGE_KEY)
    if (saved) {
      const data = JSON.parse(saved)
      state.timer.sessionAccumulatedMs = data.timer.sessionAccumulatedMs || 0
      state.selectedSubject = data.selectedSubject || SUBJECTS[0]
      dateInput.value = data.date || todayYMD()
      startTimeInput.value = data.startTime || timeIn(new Date())

      // å®Ÿè¡Œä¸­ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
      if (data.timer.running && data.timer._lastTick) {
        const lastTickTime = new Date(data.timer._lastTick).getTime()
        const now = Date.now()
        // åœæ­¢ä¸­ã«çµŒéã—ãŸæ™‚é–“ã‚’åŠ ç®—
        const elapsedSincePause = now - lastTickTime
        state.timer.sessionAccumulatedMs += elapsedSincePause
        
        // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
        state.timer.running = true
        state.timer.startTime = data.timer.startTime
        startTicking()
      } else {
        state.timer.running = false
      }
    } else {
      dateInput.value = todayYMD()
      startTimeInput.value = timeIn(new Date())
    }
  }

  // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---

  function renderSubjects() {
    subjectPalette.innerHTML = ''
    SUBJECTS.forEach(subject => {
      const btn = document.createElement('button')
      btn.className = 'subject-btn'
      btn.style.backgroundColor = subject.color
      btn.textContent = subject.name
      
      const icon = document.createElement('span')
      icon.className = 'subject-icon'
      icon.textContent = subject.icon
      btn.prepend(icon)

      if (state.selectedSubject.name === subject.name) {
        btn.classList.add('active')
      }

      btn.addEventListener('click', () => {
        state.selectedSubject = subject
        renderSubjects()
        saveLocal()
      })
      subjectPalette.appendChild(btn)
    })
  }

  function updateElapsedDisplay() {
    elapsedDisplay.textContent = fmt(state.timer.sessionAccumulatedMs)
  }

  function updateStatus(message) {
    timerStatus.textContent = message
  }

  function renderLog() {
    if (!state.user) {
      logCard.style.display = 'none'
      return
    }

    logCard.style.display = 'block'
    dailyLogEl.innerHTML = ''
    
    if (state.dailyLog.length === 0) {
      dailyLogEl.innerHTML = '<div style="color:var(--muted);text-align:center;padding:10px">æœ¬æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'
      return
    }

    state.dailyLog
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .forEach(log => {
        const item = document.createElement('div')
        item.className = 'log-item'
        
        const time = fmt(log.study_time_ms)
        const datePart = new Date(log.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
        
        item.innerHTML = `
          <div class="log-subject" style="color:${log.subject_color}">${log.subject_name}</div>
          <div>
            <span class="log-time">${time}</span>
            <span class="small" style="margin-left:8px">(${datePart} çµ‚äº†)</span>
          </div>
        `
        dailyLogEl.appendChild(item)
      })
  }

  function renderAuth() {
    if (state.user) {
      userIdDisplay.textContent = `ID: ${state.user.id.slice(0, 8)}...`
      authBtn.textContent = 'ğŸ‘‹ ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ'
      authBtn.style.backgroundColor = '#f97316'
      authBtn.onclick = signOut
    } else {
      userIdDisplay.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: æœªèªè¨¼'
      authBtn.textContent = 'ğŸ”‘ ã‚µã‚¤ãƒ³ã‚¤ãƒ³'
      authBtn.style.backgroundColor = '#0f172a'
      authBtn.onclick = signIn
    }
  }

  function renderAll() {
    updateElapsedDisplay()
    updateButtonStyles()
    renderSubjects()
    renderLog()
    renderAuth()
  }

  // --- èªè¨¼ã¨ãƒ­ã‚° ---

  async function fetchDailyLog() {
    if (!state.user) {
      state.dailyLog = []
      return
    }

    try {
      const { data, error } = await supabase
        .from('study_records')
        .select('*')
        .eq('user_id', state.user.id)
        .eq('study_date', dateInput.value) // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®ãƒ­ã‚°ã‚’å–å¾—
        .order('created_at', { ascending: false })

      if (error) throw error
      state.dailyLog = data
    } catch (e) {
      console.error('âŒ ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', e)
      state.dailyLog = []
    }
    renderLog()
  }

  function signIn() {
    window.open('embed12.html', '_blank') // èªè¨¼ãƒšãƒ¼ã‚¸ã‚’é–‹ã
  }

  async function signOut() {
    try {
      await supabase.auth.signOut()
      // onAuthStateChangeã§å‡¦ç†ã•ã‚Œã‚‹
    } catch (e) {
      console.error('ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', e)
      alert('ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ')
    }
  }

  // --- ã‚¿ã‚¤ãƒãƒ¼å‡¦ç† ---

  function startTicking() {
    if (window._tickI) clearInterval(window._tickI)
    
    // 100msã”ã¨ã«æ›´æ–°ã—ã¦ã€ã‚ˆã‚Šæ»‘ã‚‰ã‹ã«ã™ã‚‹
    window._tickI = setInterval(() => {
      if (!state.timer.running) {
        clearInterval(window._tickI)
        return
      }
      
      const now = Date.now()
      if (state.timer._lastTick) {
        const delta = now - state.timer._lastTick
        state.timer.sessionAccumulatedMs += delta
      }
      state.timer._lastTick = now
      updateElapsedDisplay()
    }, 100)
    updateStatus('è¨ˆæ¸¬ä¸­...')
  }

  function startTimer() {
    if (state.timer.running) return
    if (!state.user) {
      alert('å­¦ç¿’ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã¾ãšã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚')
      signIn()
      return
    }
    
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ãªãã¦ã‚‚ã€ãƒãƒ¼ã‚ºçŠ¶æ…‹ã‹ã‚‰å†é–‹ã§ãã‚‹ã‚ˆã†ã«
    if (state.timer.sessionAccumulatedMs === 0) {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ0ã‹ã‚‰é–‹å§‹ã™ã‚‹å ´åˆã¯ã€é–‹å§‹æ™‚åˆ»ã¨æ—¥ä»˜ã‚’å†è¨­å®š
      dateInput.value = todayYMD()
      startTimeInput.value = timeIn(new Date())
    }

    state.timer.running = true
    state.timer._lastTick = Date.now()
    startTicking()
    updateButtonStyles()
    saveLocal()
  }

  async function pauseTimer() {
    if (!state.timer.running) return
    state.timer.running = false
    clearInterval(window._tickI)
    
    updateStatus('åœæ­¢ä¸­')
    updateButtonStyles()
    saveLocal()

    const studyTimeMs = state.timer.sessionAccumulatedMs
    
    if(studyTimeMs >= TIME_THRESHOLD_MS){
      try{
        const user = state.user
        if(!user){
          alert('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚')
          return
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        const { error } = await supabase
          .from('study_records')
          .insert({
            user_id: user.id,
            study_date: dateInput.value,
            start_time: startTimeInput.value,
            study_time_ms: studyTimeMs,
            subject_name: state.selectedSubject.name,
            subject_color: state.selectedSubject.color
          })
          
        if(error){
          console.error('âŒ Supabaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error)
          alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
        } else {
          console.log('âœ… Supabaseä¿å­˜æˆåŠŸ')
          alert(`ãŠç–²ã‚Œæ§˜ã§ã—ãŸ!\n${fmt(studyTimeMs)} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`)
          
          // è¨˜éŒ²æˆåŠŸå¾Œã€ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
          resetTimer(false) // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ã§ãƒªã‚»ãƒƒãƒˆ
          await fetchDailyLog() // ãƒ­ã‚°ã‚’æ›´æ–°
        }
      }catch(e){
        console.error('âŒ ä¿å­˜å‡¦ç†ã®ä¾‹å¤–:', e)
        alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
      }
    } else {
      console.log('â­ï¸ 1ç§’æœªæº€ã®ãŸã‚ä¿å­˜ã‚¹ã‚­ãƒƒãƒ—')
      // ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸå ´åˆã‚‚ãƒªã‚»ãƒƒãƒˆ
      resetTimer(false) 
    }
    console.log('â¸ï¸ ã‚¿ã‚¤ãƒãƒ¼åœæ­¢å‡¦ç†å®Œäº†')
  }

  function resetTimer(confirmRequired = true){ 
    if(confirmRequired && !confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) return
    
    state.timer.running = false
    clearInterval(window._tickI)
    state.timer._lastTick = null
    state.timer.sessionAccumulatedMs = 0
    updateElapsedDisplay()
    updateButtonStyles()
    saveLocal()
    renderAll()
    updateStatus('åœæ­¢ä¸­')
  }

  function onSetNow(){ 
    startTimeInput.value = timeIn(new Date())
  }

  function updateButtonStyles(){ 
    if(state.timer.running){ 
      startBtn.textContent = 'åœæ­¢'
      startBtn.classList.add('running')
    } else { 
      startBtn.textContent = 'é–‹å§‹'
      startBtn.classList.remove('running')
    }
  }

  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
  
  startBtn.addEventListener('click', ()=> {
    if(state.timer.running) pauseTimer()
    else startTimer()
  })
  resetBtn.addEventListener('click', () => resetTimer())
  setNowBtn.addEventListener('click', onSetNow)
  dateInput.addEventListener('change', ()=> {
    saveLocal()
    fetchDailyLog() // æ—¥ä»˜å¤‰æ›´ã§ãƒ­ã‚°ã‚’å†å–å¾—
  })
  
  // --- åˆæœŸåŒ– ---

  ;(async function init(){
    loadLocal()
    
    // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        state.user = session.user
      } else {
        state.user = null
      }
      renderAuth()
      fetchDailyLog() // èªè¨¼çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰ãƒ­ã‚°ã‚’å†å–å¾—
    })
    
    // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await supabase.auth.getUser()
    state.user = user
    
    renderAll()
    fetchDailyLog()

  })()
</script>
</body>
</html>
