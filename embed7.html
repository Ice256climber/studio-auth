<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
  <style>
    :root{ --bg:#f6f8fb; --card:#fff; --accent:#4461f2; --accent-avg:#10b981; }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,'Noto Sans JP',sans-serif;background:var(--bg);margin:0;padding:20px;color:#0f1724}
    .container{max-width:1400px;margin:0 auto}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:40px;border-radius:12px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}
    h1{margin:0 0 10px 0;font-size:32px}
    .subtitle{opacity:0.9;font-size:16px}
    .nav{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-btn{padding:12px 24px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;text-decoration:none;color:#0f1724}
    .nav-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent);transform:translateY(-2px)}
    .nav-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(16,24,40,0.06);margin-bottom:20px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:20px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .stat-value{font-size:36px;font-weight:800;margin-bottom:8px}
    .stat-label{font-size:14px;opacity:0.9}
    
    /* ã‚°ãƒªãƒƒãƒ‰ã‚’2ã‚«ãƒ©ãƒ ã«æœ€é©åŒ– */
    .student-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
    
    .student-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.06);border:1px solid #e5e7eb}
    .student-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #f3f4f6}
    .student-name{font-size:18px;font-weight:700;color:#0f1724}
    .student-id{font-size:13px;color:#6b7280;margin-top:4px}
    .student-stats{display:flex;gap:16px;margin-bottom:16px}
    .mini-stat{flex:1;text-align:center;padding:12px;background:#f9fafb;border-radius:8px}
    .mini-stat-value{font-size:20px;font-weight:700;color:var(--accent)}
    .mini-stat-label{font-size:11px;color:#6b7280;margin-top:4px}
    .chart-container{width:100%;height:200px;position:relative}
    .loading{text-align:center;padding:40px;color:#6b7280}
    .error{background:#fee;color:#c00;padding:16px;border-radius:8px;margin-bottom:20px}
    .refresh-btn{padding:10px 20px;background:var(--accent);color:#fff;border:0;border-radius:8px;cursor:pointer;font-weight:600;float:right}
    .refresh-btn:hover{opacity:0.9}

    /* å¹³å‡ç”¨ã‚«ãƒ©ãƒ¼ */
    .avg-color .mini-stat-value { color: var(--accent-avg); }
    .avg-color .student-header div:last-child div:first-child { color: var(--accent-avg); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“š å­¦ç¿’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="subtitle">ã‚ãªãŸã®å­¦ç¿’çŠ¶æ³ã¨å…¨ä½“ã®å¹³å‡ã‚’æ¯”è¼ƒ</div>
    </div>

    <div id="errorMessage" class="error" style="display:none"></div>

    <div class="stats-grid" id="overallStats">
      <div class="stat-card" style="background:linear-gradient(135deg,#667eea,#764ba2)">
        <div class="stat-value" id="myTotalHours">0h</div>
        <div class="stat-label">ã‚ãªãŸã®ç·å­¦ç¿’æ™‚é–“</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
        <div class="stat-value" id="avgTotalHours">0h</div>
        <div class="stat-label">å…¨ä½“ã®å¹³å‡å­¦ç¿’æ™‚é–“</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
        <div class="stat-value" id="myRank">-</div>
        <div class="stat-label">å­¦å¹´é †ä½</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#43e97b,#38f9d7)">
        <div class="stat-value" id="activeToday">0</div>
        <div class="stat-label">ä»Šæ—¥ã®å­¦ç¿’è€…æ•°</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="margin:0">å­¦ç¿’æ¨ç§»æ¯”è¼ƒï¼ˆéå»7æ—¥é–“ï¼‰</h2>
        <button class="refresh-btn" onclick="loadData()">ğŸ”„ æ›´æ–°</button>
      </div>
      <div id="studentGraphs" class="student-grid">
        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    window.supabase = supabase

    const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`

    function lastNDates(n) {
      const today = new Date()
      const arr = []
      for(let i = n-1; i >= 0; i--) {
        const d = new Date(today)
        d.setDate(today.getDate() - i)
        arr.push(ymd(d))
      }
      return arr
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage')
      errorEl.textContent = message
      errorEl.style.display = 'block'
      setTimeout(() => errorEl.style.display = 'none', 8000)
    }

    // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°ï¼ˆè‰²æŒ‡å®šã‚’è¿½åŠ ï¼‰
    function drawLineChart(canvasId, dates, values, colorHex) {
      const canvas = document.getElementById(canvasId)
      if (!canvas) return
      
      const ctx = canvas.getContext('2d')
      const width = canvas.width
      const height = canvas.height
      
      // èƒŒæ™¯
      ctx.fillStyle = '#ffffff'
      ctx.fillRect(0, 0, width, height)
      
      // ã‚°ãƒªãƒƒãƒ‰ç·š
      ctx.strokeStyle = '#f0f0f0'
      ctx.lineWidth = 1
      for(let i = 0; i <= 4; i++) {
        const y = (height - 40) * (i / 4) + 10
        ctx.beginPath()
        ctx.moveTo(40, y)
        ctx.lineTo(width - 10, y)
        ctx.stroke()
      }
      
      const maxValue = Math.max(...values, 1)
      const stepX = (width - 60) / (dates.length - 1)
      
      // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
      const points = values.map((val, i) => ({
        x: 40 + i * stepX,
        y: 10 + (height - 50) * (1 - val / maxValue)
      }))
      
      // ã‚¨ãƒªã‚¢å¡—ã‚Šã¤ã¶ã—ï¼ˆé€æ˜åº¦ã‚ã‚Šï¼‰
      // Hexã‹ã‚‰RGBã¸å¤‰æ›ã—ã¦é€æ˜åº¦ä»˜ä¸
      const r = parseInt(colorHex.slice(1, 3), 16)
      const g = parseInt(colorHex.slice(3, 5), 16)
      const b = parseInt(colorHex.slice(5, 7), 16)
      ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.1)`

      ctx.beginPath()
      ctx.moveTo(points[0].x, height - 30)
      points.forEach(p => ctx.lineTo(p.x, p.y))
      ctx.lineTo(points[points.length - 1].x, height - 30)
      ctx.closePath()
      ctx.fill()
      
      // æŠ˜ã‚Œç·š
      ctx.strokeStyle = colorHex
      ctx.lineWidth = 3
      ctx.beginPath()
      ctx.moveTo(points[0].x, points[0].y)
      points.forEach(p => ctx.lineTo(p.x, p.y))
      ctx.stroke()
      
      // ãƒã‚¤ãƒ³ãƒˆ
      points.forEach((p, i) => {
        ctx.fillStyle = colorHex
        ctx.beginPath()
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2)
        ctx.fill()
        
        // å€¤ãƒ©ãƒ™ãƒ«
        ctx.fillStyle = '#0f1724'
        ctx.font = '11px Inter, sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText(values[i].toFixed(1) + 'h', p.x, p.y - 10)
      })
      
      // æ—¥ä»˜ãƒ©ãƒ™ãƒ«
      dates.forEach((date, i) => {
        const x = 40 + i * stepX
        ctx.fillStyle = '#6b7280'
        ctx.font = '10px Inter, sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText(date.slice(5), x, height - 10)
      })
    }

    async function loadData() {
      try {
        console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹')
        
        const dates = lastNDates(7)
        const today = ymd(new Date())
        
        // éå»7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
        const { data: records, error } = await supabase
          .from('study_records')
          .select('user_id, study_date, study_time_ms')
          .gte('study_date', dates[0])
          .lte('study_date', dates[dates.length - 1])
        
        if (error) throw error
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é›†è¨ˆ
        const userStats = {}
        records.forEach(record => {
          if (!userStats[record.user_id]) {
            userStats[record.user_id] = {
              userId: record.user_id,
              dailyHours: {},
              totalMs: 0,
              recordCount: 0
            }
          }
          const dateKey = record.study_date
          if (!userStats[record.user_id].dailyHours[dateKey]) {
            userStats[record.user_id].dailyHours[dateKey] = 0
          }
          userStats[record.user_id].dailyHours[dateKey] += record.study_time_ms
          userStats[record.user_id].totalMs += record.study_time_ms
          userStats[record.user_id].recordCount++
        })
        
        const userList = Object.values(userStats)
        const totalStudents = userList.length

        // â–  1. ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®šï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        // æœ¬æ¥ã¯ auth.user() ã§IDã‚’å–å¾—ã—ã¾ã™ãŒã€ãƒ‡ãƒ¢ã®ãŸã‚ã€Œæœ€ã‚‚å­¦ç¿’æ™‚é–“ãŒé•·ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ã€Œã‚ãªãŸã€ã¨ä»®å®šã—ã¾ã™
        userList.sort((a, b) => b.totalMs - a.totalMs)
        const myData = userList.length > 0 ? userList[0] : null
        
        // â–  2. å…¨ä½“ã®å¹³å‡ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
        // æ—¥ã”ã¨ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆè¨ˆæ™‚é–“ Ã· å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
        const averageDailyHours = dates.map(date => {
            // ãã®æ—¥ã®å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã®åˆè¨ˆæ™‚é–“
            const dailySumMs = records
                .filter(r => r.study_date === date)
                .reduce((sum, r) => sum + r.study_time_ms, 0)
            
            // å¹³å‡è¨ˆç®— (ms -> hours) 0é™¤ç®—å›é¿
            return totalStudents > 0 ? (dailySumMs / totalStudents) / 3600000 : 0
        })

        const averageTotalMs = userList.reduce((sum, u) => sum + u.totalMs, 0) / (totalStudents || 1)

        // ä»Šæ—¥å­¦ç¿’ã—ãŸäººæ•°
        const activeToday = new Set(records.filter(r => r.study_date === today).map(r => r.user_id)).size
        
        // çµ±è¨ˆãƒ‘ãƒãƒ«æ›´æ–°
        if(myData) {
            document.getElementById('myTotalHours').textContent = (myData.totalMs / 3600000).toFixed(1) + 'h'
            // 1ä½å›ºå®šã§ã™ãŒãƒ­ã‚¸ãƒƒã‚¯ã¨ã—ã¦ã¯ã“ã†ãªã‚Šã¾ã™
            const rank = userList.findIndex(u => u.userId === myData.userId) + 1
            document.getElementById('myRank').textContent = `${rank}ä½ / ${totalStudents}äºº`
        }
        document.getElementById('avgTotalHours').textContent = (averageTotalMs / 3600000).toFixed(1) + 'h'
        document.getElementById('activeToday').textContent = activeToday
        
        // ã‚°ãƒ©ãƒ•æç”»ï¼ˆè‡ªåˆ† vs å¹³å‡ï¼‰
        renderComparisonGraphs(myData, averageDailyHours, dates)
        
      } catch (error) {
        console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error)
        showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    }

    function renderComparisonGraphs(userData, averageDailyHours, dates) {
      const container = document.getElementById('studentGraphs')
      container.innerHTML = ''
      
      if (!userData) {
        container.innerHTML = '<div class="loading">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'
        return
      }

      // --- ã‚«ãƒ¼ãƒ‰1: ã‚ãªãŸã®å­¦ç¿’ ---
      const myCard = createCardHTML(
          'ã‚ãªãŸ (ãƒ­ã‚°ã‚¤ãƒ³ä¸­)',
          userData.userId,
          userData.totalMs,
          userData.recordCount,
          dates.map(d => (userData.dailyHours[d] || 0) / 3600000),
          dates,
          0, // index
          '#4461f2', // Blue
          false
      )
      container.appendChild(myCard)

      // --- ã‚«ãƒ¼ãƒ‰2: å…¨ä½“ã®å¹³å‡ ---
      // å¹³å‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã£ã½ã„å½¢å¼ã«æ•´å½¢ã—ã¦æ¸¡ã™
      const avgTotalMs = averageDailyHours.reduce((sum, h) => sum + h, 0) * 3600000
      
      const avgCard = createCardHTML(
          'å…¨ä½“ã®å¹³å‡',
          'All Students',
          avgTotalMs,
          '-', // å›æ•°ã¯å¹³å‡åŒ–ã—ã«ãã„ã®ã§ãƒã‚¤ãƒ•ãƒ³
          averageDailyHours,
          dates,
          1, // index
          '#10b981', // Green
          true // isAverage
      )
      container.appendChild(avgCard)

      // æç”»å®Ÿè¡Œ
      setTimeout(() => {
          // è‡ªåˆ†ã®ã‚°ãƒ©ãƒ•
          const myValues = dates.map(d => (userData.dailyHours[d] || 0) / 3600000)
          drawLineChart('chart-0', dates, myValues, '#4461f2')

          // å¹³å‡ã®ã‚°ãƒ©ãƒ•
          drawLineChart('chart-1', dates, averageDailyHours, '#10b981')
      }, 100)
    }

    function createCardHTML(title, subtitle, totalMs, count, dailyValues, dates, index, color, isAverage) {
        const card = document.createElement('div')
        card.className = 'student-card' + (isAverage ? ' avg-color' : '')
        
        const totalHours = (totalMs / 3600000).toFixed(1)
        const maxDay = Math.max(...dailyValues)
        
        // å¹³å‡æ™‚é–“ã¯countãŒæ•°å€¤ã§ãªã„å ´åˆ(å¹³å‡ã‚«ãƒ¼ãƒ‰)ã¯è¨ˆç®—ã—ãªã„
        const avgPerSession = (typeof count === 'number' && count > 0) 
            ? (totalMs / count / 3600000).toFixed(1) 
            : '-'

        const canvasId = `chart-${index}`
        
        card.innerHTML = `
          <div class="student-header">
            <div>
              <div class="student-name">${title}</div>
              <div class="student-id">${isAverage ? 'ã‚¯ãƒ©ã‚¹å…¨ä½“ã®çµ±è¨ˆ' : 'ID: ' + subtitle}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:24px;font-weight:800;color:${color}">${totalHours}h</div>
              <div style="font-size:11px;color:#6b7280">æœŸé–“åˆè¨ˆ</div>
            </div>
          </div>
          
          <div class="student-stats">
            <div class="mini-stat">
              <div class="mini-stat-value">${count}</div>
              <div class="mini-stat-label">å­¦ç¿’å›æ•°</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-value">${avgPerSession}h</div>
              <div class="mini-stat-label">1å›å¹³å‡</div>
            </div>
            <div class="mini-stat">
              <div class="mini-stat-value">${maxDay.toFixed(1)}h</div>
              <div class="mini-stat-label">æœ€é«˜è¨˜éŒ²</div>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="${canvasId}" width="380" height="200"></canvas>
          </div>
        `
        return card
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.loadData = loadData

    // åˆæœŸåŒ–
    loadData()
    setInterval(loadData, 300000)
  </script>
</body>
</html>
