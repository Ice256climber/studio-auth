<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
  <style>
    /* ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼å®šç¾© */
    :root { 
      --bg: #f6f8fb; 
      --card: #ffffff; 
      --text-main: #0f1724;
      --text-sub: #6b7280;
      /* å€‹äººã®è‰²ï¼ˆé’ï¼‰ */
      --color-student: #4461f2; 
      /* å¹³å‡ã®è‰²ï¼ˆç·‘ãƒ»ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ï¼‰ */
      --color-average: #10b981; 
    }

    * { box-sizing: border-box; }
    body { font-family: Inter, system-ui, 'Noto Sans JP', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-main); }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 40px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    h1 { margin: 0 0 10px 0; font-size: 32px; }
    .subtitle { opacity: 0.9; font-size: 16px; }

    /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .error { background: #fee; color: #c00; padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none; }
    
    /* çµ±è¨ˆãƒ‘ãƒãƒ«ï¼ˆä¸Šéƒ¨ï¼‰ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .stat-value { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
    .stat-label { font-size: 14px; opacity: 0.9; }

    /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ï¼ˆã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢å…¨ä½“ï¼‰ */
    .main-card { background: transparent; box-shadow: none; padding: 0; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(16,24,40,0.06); }
    .refresh-btn { padding: 10px 20px; background: var(--color-student); color: #fff; border: 0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: opacity 0.2s; }
    .refresh-btn:hover { opacity: 0.9; }

    /* ç”Ÿå¾’ãƒ»å¹³å‡æ¯”è¼ƒã‚°ãƒªãƒƒãƒ‰ */
    .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    
    /* å€‹åˆ¥ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .data-card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border: 1px solid #e5e7eb; display: flex; flex-direction: column; }
    
    .data-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #f3f4f6; }
    .user-name { font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
    .user-id { font-size: 13px; color: var(--text-sub); }
    .total-time { font-size: 28px; font-weight: 800; line-height: 1; }
    .total-label { font-size: 11px; color: var(--text-sub); margin-top: 4px; text-align: right; }

    .data-stats { display: flex; gap: 12px; margin-bottom: 20px; }
    .mini-stat { flex: 1; text-align: center; padding: 12px 8px; background: #f9fafb; border-radius: 8px; border: 1px solid #f3f4f6; }
    .mini-stat-value { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .mini-stat-label { font-size: 11px; color: var(--text-sub); }

    .chart-wrapper { position: relative; width: 100%; height: 220px; }
    .loading { text-align: center; padding: 40px; color: var(--text-sub); width: 100%; }

    /* ã‚«ãƒ©ãƒ¼é©ç”¨ã‚¯ãƒ©ã‚¹ */
    .theme-student .total-time,
    .theme-student .mini-stat-value { color: var(--color-student); }
    
    .theme-average .total-time,
    .theme-average .mini-stat-value { color: var(--color-average); }
    
    /* å¹³å‡ã‚«ãƒ¼ãƒ‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹ç·šè‰²å¤‰æ›´ */
    .theme-average .data-header { border-bottom-color: rgba(16, 185, 129, 0.1); }
    .theme-average .mini-stat { background: rgba(16, 185, 129, 0.03); }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“š å­¦ç¿’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="subtitle">å€‹äººã®å­¦ç¿’è¨˜éŒ²ã¨ã‚¯ãƒ©ã‚¹å…¨ä½“ã®å¹³å‡æ¨ç§»</div>
    </div>

    <div id="errorMessage" class="error"></div>

    <div class="stats-grid">
      <div class="stat-card" style="background:linear-gradient(135deg,#667eea,#764ba2)">
        <div class="stat-value" id="dispMyTotal">0h</div>
        <div class="stat-label">ã‚ãªãŸã®æœŸé–“åˆè¨ˆ</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#10b981,#059669)">
        <div class="stat-value" id="dispAvgTotal">0h</div>
        <div class="stat-label">ã‚¯ãƒ©ã‚¹å¹³å‡ (æœŸé–“)</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
        <div class="stat-value" id="dispMyRank">-</div>
        <div class="stat-label">ã‚¯ãƒ©ã‚¹é †ä½</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
        <div class="stat-value" id="dispActive">0</div>
        <div class="stat-label">ä»Šæ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç”Ÿå¾’</div>
      </div>
    </div>

    <div class="main-card">
      <div class="card-header">
        <h2 style="margin:0; font-size:18px;">å­¦ç¿’æ¨ç§»æ¯”è¼ƒï¼ˆéå»7æ—¥é–“ï¼‰</h2>
        <button class="refresh-btn" onclick="app.load()">ğŸ”„ æ›´æ–°</button>
      </div>
      
      <div id="graphsArea" class="comparison-grid">
        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    const app = {
      // æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
      utils: {
        ymd: (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`,
        getLastNDates: (n) => {
          const arr = []
          const today = new Date()
          for(let i=n-1; i>=0; i--){
            const d = new Date(today)
            d.setDate(today.getDate() - i)
            arr.push(app.utils.ymd(d))
          }
          return arr
        },
        msToHours: (ms) => (ms / 3600000)
      },

      // ã‚°ãƒ©ãƒ•æç”»ï¼ˆChart.jsç­‰ã‚’ä½¿ã‚ãšCanvasã§ç›´æ¥æç”»ã—ã¦è»½é‡åŒ–ï¼‰
      drawChart: (canvasId, labels, data, color) => {
        const canvas = document.getElementById(canvasId)
        if (!canvas) return
        const ctx = canvas.getContext('2d')
        const w = canvas.width
        const h = canvas.height
        
        // ã‚¯ãƒªã‚¢ & èƒŒæ™¯
        ctx.clearRect(0,0,w,h)
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h)

        // ã‚°ãƒªãƒƒãƒ‰ç·š
        ctx.strokeStyle = '#f3f4f6'; ctx.lineWidth = 1
        for(let i=0; i<=4; i++){
          const y = (h - 40) * (i/4) + 10
          ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(w-10,y); ctx.stroke()
        }

        const maxVal = Math.max(...data, 1) // 0é™¤ç®—é˜²æ­¢
        const stepX = (w - 60) / (labels.length - 1)

        // åº§æ¨™è¨ˆç®—
        const points = data.map((val, i) => ({
          x: 40 + i * stepX,
          y: 10 + (h - 50) * (1 - val / maxVal)
        }))

        // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¡—ã‚Šã¤ã¶ã—
        const r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16)
        const gradient = ctx.createLinearGradient(0, 0, 0, h)
        gradient.addColorStop(0, `rgba(${r},${g},${b}, 0.2)`)
        gradient.addColorStop(1, `rgba(${r},${g},${b}, 0.0)`)
        
        ctx.fillStyle = gradient
        ctx.beginPath()
        ctx.moveTo(points[0].x, h-30)
        points.forEach(p => ctx.lineTo(p.x, p.y))
        ctx.lineTo(points[points.length-1].x, h-30)
        ctx.fill()

        // æŠ˜ã‚Œç·š
        ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineJoin = 'round'
        ctx.beginPath()
        ctx.moveTo(points[0].x, points[0].y)
        points.forEach(p => ctx.lineTo(p.x, p.y))
        ctx.stroke()

        // ç‚¹ã¨ãƒ©ãƒ™ãƒ«
        points.forEach((p, i) => {
          // ç‚¹
          ctx.fillStyle = '#fff'; ctx.strokeStyle = color; ctx.lineWidth = 2
          ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); ctx.stroke()
          
          // æ•°å€¤
          ctx.fillStyle = '#0f1724'; ctx.font = 'bold 11px Inter'; ctx.textAlign = 'center'
          ctx.fillText(data[i].toFixed(1), p.x, p.y - 12)
          
          // æ—¥ä»˜
          ctx.fillStyle = '#9ca3af'; ctx.font = '10px Inter';
          ctx.fillText(labels[i].slice(5), p.x, h - 10)
        })
      },

      // HTMLç”Ÿæˆ: ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
      createCardHtml: (type, title, subTitle, stats, canvasId) => {
        const themeClass = type === 'me' ? 'theme-student' : 'theme-average'
        // stats: { totalH, count, avgH, maxH }
        return `
          <div class="data-card ${themeClass}">
            <div class="data-header">
              <div>
                <div class="user-name">${title}</div>
                <div class="user-id">${subTitle}</div>
              </div>
              <div>
                <div class="total-time">${stats.totalH}h</div>
                <div class="total-label">æœŸé–“åˆè¨ˆ</div>
              </div>
            </div>
            
            <div class="data-stats">
              <div class="mini-stat">
                <div class="mini-stat-value">${stats.count}</div>
                <div class="mini-stat-label">å­¦ç¿’å›æ•°</div>
              </div>
              <div class="mini-stat">
                <div class="mini-stat-value">${stats.avgH}h</div>
                <div class="mini-stat-label">1å›å¹³å‡</div>
              </div>
              <div class="mini-stat">
                <div class="mini-stat-value">${stats.maxH}h</div>
                <div class="mini-stat-label">æœ€é«˜è¨˜éŒ²</div>
              </div>
            </div>

            <div class="chart-wrapper">
              <canvas id="${canvasId}" width="400" height="220"></canvas>
            </div>
          </div>
        `
      },

      // ãƒ¡ã‚¤ãƒ³å‡¦ç†
      load: async () => {
        try {
          const dates = app.utils.getLastNDates(7)
          const today = app.utils.ymd(new Date())
          
          // ãƒ‡ãƒ¼ã‚¿å–å¾—
          const { data: records, error } = await supabase
            .from('study_records')
            .select('*')
            .gte('study_date', dates[0])
            .lte('study_date', dates[dates.length-1])

          if(error) throw error

          // é›†è¨ˆå‡¦ç†
          const usersMap = {}
          let totalRecordCountAllUsers = 0 // å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ï¼ˆå¹³å‡è¨ˆç®—ç”¨ï¼‰

          records.forEach(r => {
            if(!usersMap[r.user_id]) {
              usersMap[r.user_id] = { id: r.user_id, totalMs: 0, count: 0, daily: {} }
            }
            if(!usersMap[r.user_id].daily[r.study_date]) usersMap[r.user_id].daily[r.study_date] = 0
            
            usersMap[r.user_id].daily[r.study_date] += r.study_time_ms
            usersMap[r.user_id].totalMs += r.study_time_ms
            usersMap[r.user_id].count++
            totalRecordCountAllUsers++
          })

          const userList = Object.values(usersMap)
          const studentCount = userList.length || 1

          // 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼šãƒ©ãƒ³ãƒ€ãƒ ãª1åï¼‰
          let me = userList.length > 0 ? userList[Math.floor(Math.random() * userList.length)] : null
          
          // è‡ªåˆ†ã®ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ä½œæˆ
          const myDailyHours = dates.map(d => app.utils.msToHours(me ? (me.daily[d] || 0) : 0))
          const myStats = me ? {
            totalH: app.utils.msToHours(me.totalMs).toFixed(1),
            count: me.count,
            avgH: (app.utils.msToHours(me.totalMs) / (me.count || 1)).toFixed(1),
            maxH: Math.max(...myDailyHours).toFixed(1)
          } : { totalH:'0.0', count:0, avgH:'0.0', maxH:'0.0' }

          // 2. å¹³å‡ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆã‚ã›ã‚‹ãŸã‚å…¨é …ç›®è¨ˆç®—ï¼‰
          const avgDailyHours = dates.map(d => {
            // ãã®æ—¥ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆè¨ˆæ™‚é–“
            const dailySum = records
              .filter(r => r.study_date === d)
              .reduce((acc, cur) => acc + cur.study_time_ms, 0)
            // å¹³å‡æ™‚é–“(h) = åˆè¨ˆ / äººæ•°
            return app.utils.msToHours(dailySum / studentCount)
          })

          // å¹³å‡ã®çµ±è¨ˆæƒ…å ±
          const avgTotalMs = userList.reduce((sum, u) => sum + u.totalMs, 0) / studentCount
          const avgRecordCount = totalRecordCountAllUsers / studentCount
          
          const avgStats = {
            totalH: app.utils.msToHours(avgTotalMs).toFixed(1),
            count: avgRecordCount.toFixed(1), // å¹³å‡å›æ•°ï¼ˆå°æ•°ã‚ã‚Šï¼‰
            avgH: (app.utils.msToHours(avgTotalMs) / (avgRecordCount || 1)).toFixed(1),
            maxH: Math.max(...avgDailyHours).toFixed(1)
          }

          // HTMLæç”»
          const container = document.getElementById('graphsArea')
          container.innerHTML = ''
          
          if(me) {
            // ã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆ
            container.innerHTML += app.createCardHtml('me', 'ã‚ãªãŸ', `ID: ${me.id.slice(0,8)}...`, myStats, 'chart-me')
            container.innerHTML += app.createCardHtml('avg', 'ã‚¯ãƒ©ã‚¹å¹³å‡', 'å…¨ç”Ÿå¾’ã®å¹³å‡å€¤', avgStats, 'chart-avg')
            
            // ã‚°ãƒ©ãƒ•æç”»ï¼ˆDOMç”Ÿæˆå¾Œï¼‰
            setTimeout(() => {
              app.drawChart('chart-me', dates, myDailyHours, '#4461f2')
              app.drawChart('chart-avg', dates, avgDailyHours, '#10b981')
            }, 50)

            // ä¸Šéƒ¨ãƒ‘ãƒãƒ«æ›´æ–°
            const myRank = userList.sort((a,b)=>b.totalMs - a.totalMs).findIndex(u=>u.id===me.id) + 1
            document.getElementById('dispMyTotal').textContent = myStats.totalH + 'h'
            document.getElementById('dispMyRank').textContent = `${myRank}ä½ / ${studentCount}äºº`
          } else {
            container.innerHTML = '<div class="loading">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'
          }

          document.getElementById('dispAvgTotal').textContent = avgStats.totalH + 'h'
          
          // ä»Šæ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ•°
          const active = new Set(records.filter(r=>r.study_date === today).map(r=>r.user_id)).size
          document.getElementById('dispActive').textContent = active

        } catch(e) {
          console.error(e)
          document.getElementById('errorMessage').style.display = 'block'
          document.getElementById('errorMessage').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message
        }
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
    window.app = app
    app.load()
  </script>
</body>
</html>
