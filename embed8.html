<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>平均グラフ (単体機能版)</title>
  <style>
    /* 必要なスタイルのみ定義 */
    :root { 
      --bg: #f6f8fb; 
      --card: #ffffff; 
      --text: #0f1724;
      --text-sub: #6b7280;
      --avg-color: #10b981; /* 平均用の緑色 */
    }

    * { box-sizing: border-box; }
    body { font-family: Inter, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
    
    /* カードデザイン */
    .avg-card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
      max-width: 500px; /* 単体表示用に見やすく制限 */
      margin: 0 auto;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid rgba(16, 185, 129, 0.1);
    }
    
    .title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .subtitle { font-size: 13px; color: var(--avg-color); }
    
    .total-time { font-size: 28px; font-weight: 800; color: var(--avg-color); line-height: 1; text-align: right; }
    .total-label { font-size: 11px; color: var(--text-sub); margin-top: 4px; text-align: right; }

    /* 統計数値エリア */
    .stats-row { display: flex; gap: 12px; margin-bottom: 20px; }
    .stat-box { 
      flex: 1; 
      text-align: center; 
      padding: 12px 8px; 
      background: rgba(16, 185, 129, 0.03); 
      border-radius: 8px; 
      border: 1px solid rgba(16, 185, 129, 0.1); 
    }
    .stat-val { font-size: 18px; font-weight: 700; color: var(--avg-color); margin-bottom: 4px; }
    .stat-lbl { font-size: 11px; color: var(--text-sub); }

    /* グラフエリア */
    .chart-area { position: relative; width: 100%; height: 220px; }
    .loading { text-align: center; padding: 40px; color: var(--text-sub); }
  </style>
</head>
<body>

  <div id="averageCardContainer">
    <div class="avg-card">
      <div class="loading">データを読み込んでいます...</div>
    </div>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    
    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // 日付ユーティリティ
    const ymd = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
    
    // 過去7日間の日付を取得
    function getLast7Days() {
      const dates = []
      const today = new Date()
      for(let i=6; i>=0; i--){
        const d = new Date(today)
        d.setDate(today.getDate() - i)
        dates.push(ymd(d))
      }
      return dates
    }

    // グラフ描画関数 (Chart.js不使用・Canvas軽量版)
    function drawChart(canvasId, dates, values) {
      const canvas = document.getElementById(canvasId)
      if (!canvas) return
      const ctx = canvas.getContext('2d')
      const w = canvas.width
      const h = canvas.height
      const color = '#10b981' // 緑色固定

      ctx.clearRect(0,0,w,h)
      
      // グリッド線
      ctx.strokeStyle = '#f3f4f6'; ctx.lineWidth = 1
      for(let i=0; i<=4; i++){
        const y = (h - 40) * (i/4) + 10
        ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(w-10,y); ctx.stroke()
      }

      const maxVal = Math.max(...values, 1)
      const stepX = (w - 60) / (dates.length - 1)
      
      const points = values.map((val, i) => ({
        x: 40 + i * stepX,
        y: 10 + (h - 50) * (1 - val / maxVal)
      }))

      // 塗りつぶし
      const grad = ctx.createLinearGradient(0,0,0,h)
      grad.addColorStop(0, 'rgba(16, 185, 129, 0.2)')
      grad.addColorStop(1, 'rgba(16, 185, 129, 0.0)')
      ctx.fillStyle = grad
      ctx.beginPath()
      ctx.moveTo(points[0].x, h-30)
      points.forEach(p => ctx.lineTo(p.x, p.y))
      ctx.lineTo(points[points.length-1].x, h-30)
      ctx.fill()

      // 折れ線
      ctx.strokeStyle = color; ctx.lineWidth = 3
      ctx.beginPath()
      ctx.moveTo(points[0].x, points[0].y)
      points.forEach(p => ctx.lineTo(p.x, p.y))
      ctx.stroke()

      // 点と数値
      points.forEach((p, i) => {
        ctx.fillStyle = '#fff'; ctx.strokeStyle = color;
        ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); ctx.stroke()
        
        ctx.fillStyle = '#0f1724'; ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'center'
        ctx.fillText(values[i].toFixed(1), p.x, p.y - 12)
        
        ctx.fillStyle = '#9ca3af'; ctx.font = '10px sans-serif';
        ctx.fillText(dates[i].slice(5), p.x, h - 10)
      })
    }

    async function loadAverageGraph() {
      try {
        const dates = getLast7Days()
        
        // 1. データ取得
        const { data: records, error } = await supabase
          .from('study_records')
          .select('user_id, study_date, study_time_ms')
          .gte('study_date', dates[0])
          .lte('study_date', dates[dates.length-1])
        
        if(error) throw error

        // 2. 計算ロジック
        // 全ユニークユーザー数（期間内に1回でも記録がある人）
        const uniqueUsers = new Set(records.map(r => r.user_id)).size || 1
        
        // 日ごとの平均時間を計算
        // (その日の全合計 / ユーザー数)
        const avgDailyValues = dates.map(date => {
          const dailySum = records
            .filter(r => r.study_date === date)
            .reduce((sum, r) => sum + r.study_time_ms, 0)
          
          return (dailySum / uniqueUsers) / 3600000 // ms -> hours
        })

        // 全体の統計値
        const totalSumMs = records.reduce((sum, r) => sum + r.study_time_ms, 0)
        const totalAvgHours = (totalSumMs / uniqueUsers) / 3600000
        const totalRecords = records.length
        const avgCountPerUser = totalRecords / uniqueUsers
        const maxAvgDay = Math.max(...avgDailyValues)

        // 3. 表示生成
        const container = document.getElementById('averageCardContainer')
        
        container.innerHTML = `
          <div class="avg-card">
            <div class="card-header">
              <div>
                <div class="title">クラス平均</div>
                <div class="subtitle">全生徒の平均学習推移</div>
              </div>
              <div>
                <div class="total-time">${totalAvgHours.toFixed(1)}h</div>
                <div class="total-label">1人あたり期間合計</div>
              </div>
            </div>
            
            <div class="stats-row">
              <div class="stat-box">
                <div class="stat-val">${avgCountPerUser.toFixed(1)}</div>
                <div class="stat-lbl">平均学習回数</div>
              </div>
              <div class="stat-box">
                <div class="stat-val">${(totalAvgHours / avgCountPerUser || 0).toFixed(1)}h</div>
                <div class="stat-lbl">1回平均</div>
              </div>
              <div class="stat-box">
                <div class="stat-val">${maxAvgDay.toFixed(1)}h</div>
                <div class="stat-lbl">最高値(日)</div>
              </div>
            </div>

            <div class="chart-area">
              <canvas id="avgChartCanvas" width="450" height="220"></canvas>
            </div>
          </div>
        `

        // 描画実行（HTML反映後）
        setTimeout(() => {
          drawChart('avgChartCanvas', dates, avgDailyValues)
        }, 50)

      } catch (e) {
        console.error(e)
        document.getElementById('averageCardContainer').innerHTML = `<p style="color:red">エラーが発生しました: ${e.message}</p>`
      }
    }

    // 実行
    loadAverageGraph()
  </script>
</body>
</html>
