<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Studio Auth â€” ã‚µã‚¤ãƒ³ã‚¤ãƒ³ / ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-white flex items-center justify-center p-6">
  <main class="w-full max-w-lg bg-white/95 backdrop-blur-md border border-gray-200 rounded-2xl shadow-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-semibold">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h1>
      <div class="text-sm text-gray-500">å…ˆç”Ÿ / ç”Ÿå¾’ ã‚’é¸æŠã—ã¦ç™»éŒ²</div>
    </div>

    <div id="status" class="mb-4 text-sm text-gray-600">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="grid grid-cols-1 gap-4">
      <!-- ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="p-4 rounded-lg border bg-gray-50">
        <label class="block text-xs text-gray-600">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input id="email" type="email" class="w-full mt-1 p-2 rounded border" placeholder="you@example.com" />

        <label class="block text-xs text-gray-600 mt-3">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input id="password" type="password" class="w-full mt-1 p-2 rounded border" placeholder="8æ–‡å­—ä»¥ä¸Š" />

        <div class="mt-3 flex gap-2 items-center">
          <select id="role" class="p-2 rounded border">
            <option value="student">ç”Ÿå¾’</option>
            <option value="teacher">å…ˆç”Ÿ</option>
          </select>
          <button id="btn-signup" class="ml-auto py-2 px-4 rounded bg-green-600 text-white hover:bg-green-700">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
          <button id="btn-signin" class="py-2 px-4 rounded border hover:bg-gray-50">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
        </div>

        <div class="mt-3 text-center">
          <button id="btn-reset" class="text-xs text-gray-500 hover:text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <!-- ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®è¡¨ç¤º -->
      <div id="after" class="hidden mt-2 p-4 rounded border bg-white">
        <h2 class="font-medium text-lg" id="welcomeTitle"></h2>
        <p class="text-sm text-gray-600 mt-2 whitespace-pre-line" id="welcomeBody"></p>
        <div class="mt-3 flex gap-2">
          <button id="btn-signout" class="py-2 px-4 rounded border hover:bg-gray-50">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
          <a href="embed4.html" class="py-2 px-4 rounded bg-blue-600 text-white hover:bg-blue-700">ã‚¿ã‚¤ãƒãƒ¼ã¸</a>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', (e) => {
      console.error('âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', e.message, e.error)
      document.getElementById('status').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message
    })

    window.addEventListener('unhandledrejection', (e) => {
      console.error('âŒ Promiseæ‹’å¦:', e.reason)
      document.getElementById('status').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.reason
    })

    console.log('ğŸš€ ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹')

    // Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šï¼‰
    let createClient
    try {
      console.log('ğŸ“¦ Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ä¸­...')
      const module = await import('https://unpkg.com/@supabase/supabase-js@2.39.0/dist/module/index.js')
      createClient = module.createClient
      console.log('âœ… Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿æˆåŠŸ')
    } catch(e) {
      console.error('âŒ Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¤±æ•—:', e)
      document.getElementById('status').textContent = 'âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message
      throw e
    }

    const SUPABASE_URL = 'https://pscowkpzgomszpvjtnge.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzY293a3B6Z29tc3pwdmp0bmdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjIwNTUsImV4cCI6MjA3NTk5ODA1NX0.CVRZM4e-vXxGWzLCK6aOIANJjQ0NpVwSuTfTeQbvQg0'

    // ç¾åœ¨ã®URLã‚’å–å¾—ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ï¼‰
    const getRedirectUrl = () => {
      // æœ¬ç•ªç’°å¢ƒã®URLã«ç½®ãæ›ãˆã¦ãã ã•ã„
      const production = 'https://ice256climber.github.io/studio-auth/embed11.html'
      
      // é–‹ç™ºç’°å¢ƒã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const isDev = window.location.hostname === 'localhost' || 
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname.includes('192.168')
      
      // é–‹ç™ºç’°å¢ƒã®å ´åˆã¯ç¾åœ¨ã®URLã‚’ä½¿ç”¨ã€æœ¬ç•ªç’°å¢ƒã§ã¯å›ºå®šURLã‚’ä½¿ç”¨
      return isDev ? window.location.origin + window.location.pathname : production
    }

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
    let supabase
    try {
      console.log('ğŸ”§ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ä¸­...')
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storage: window.localStorage,
          storageKey: 'supabase.auth.token',
          flowType: 'pkce'
        }
      })
      console.log('âœ… Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–æˆåŠŸ')
      window.supabase = supabase
    } catch(e) {
      console.error('âŒ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å¤±æ•—:', e)
      document.getElementById('status').textContent = 'âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + e.message
      throw e
    }

    const statusEl = document.getElementById('status')
    const btnSignin = document.getElementById('btn-signin')
    const btnSignup = document.getElementById('btn-signup')
    const btnReset = document.getElementById('btn-reset')
    const btnSignout = document.getElementById('btn-signout')
    const emailInput = document.getElementById('email')
    const passwordInput = document.getElementById('password')
    const roleSelect = document.getElementById('role')
    const afterEl = document.getElementById('after')
    const welcomeTitle = document.getElementById('welcomeTitle')
    const welcomeBody = document.getElementById('welcomeBody')

    function showStatus(msg) {
      statusEl.innerText = msg
      console.log('ğŸ“Œ Status:', msg)
    }

    async function refreshSession() {
      try {
        // URLå†…ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¡ãƒ¼ãƒ«èªè¨¼å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
        const hashParams = new URLSearchParams(window.location.hash.substring(1))
        const accessToken = hashParams.get('access_token')
        
        if (accessToken) {
          console.log('âœ… ãƒ¡ãƒ¼ãƒ«èªè¨¼å¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ')
          showStatus('ğŸ“§ ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å‡¦ç†ä¸­...')
          
          // URLã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹
          window.history.replaceState(null, '', window.location.pathname)
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
        const { data: { session }, error: sessionError } = await supabase.auth.getSession()
        
        if (sessionError) {
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError)
          showStatus('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚')
          return null
        }
        
        if (session?.user) {
          const user = session.user
          console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª:', user.email)
          
          // user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å½¹å‰²ã‚’å–å¾—
          const { data: userRow, error: profileError } = await supabase
            .from('user_profiles')
            .select('role')
            .eq('user_id', user.id)
            .maybeSingle()
          
          if (profileError) {
            console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', profileError)
          }
          
          const role = userRow?.role || 'student'
          showSignedIn(user.email, role)
          
          // ãƒ¡ãƒ¼ãƒ«èªè¨¼å¾Œã®å ´åˆã¯ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if (accessToken) {
            showStatus('âœ… ãƒ¡ãƒ¼ãƒ«èªè¨¼å®Œäº†ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚')
          }
          
          return user
        } else {
          showStatus('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚')
          return null
        }
      } catch (e) {
        console.error('èªè¨¼ç¢ºèªã‚¨ãƒ©ãƒ¼:', e)
        showStatus('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚')
        return null
      }
    }

    function showSignedIn(email, role) {
      afterEl.classList.remove('hidden')
      welcomeTitle.innerText = role === 'teacher' ? 'ğŸ‘¨â€ğŸ« å…ˆç”Ÿã‚ˆã†ã“ãï¼' : 'ğŸ‘¨â€ğŸ“ ç”Ÿå¾’ã•ã‚“ã‚ˆã†ã“ãï¼'
      welcomeBody.innerText = `ãƒ­ã‚°ã‚¤ãƒ³: ${email}\nå½¹å‰²: ${role}`
      showStatus('âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿')
    }

    // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
    btnSignup.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      const password = passwordInput.value
      const role = roleSelect.value
      
      if (!email || password.length < 8) {
        showStatus('âŒ ãƒ¡ãƒ¼ãƒ«ã¨8æ–‡å­—ä»¥ä¸Šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        return
      }
      
      btnSignup.disabled = true
      showStatus('ğŸ“ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ä¸­...')
      
      try {
        const redirectUrl = getRedirectUrl()
        console.log('ğŸ”— ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL:', redirectUrl)
        
        const { data, error } = await supabase.auth.signUp({ 
          email, 
          password,
          options: {
            data: {
              role: role
            },
            emailRedirectTo: redirectUrl // â† ã“ã“ãŒé‡è¦ï¼
          }
        })
        
        if (error) throw error
        
        // user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ã«å½¹å‰²ã‚’ä¿å­˜
        if (data?.user?.id) {
          const { error: profileError } = await supabase
            .from('user_profiles')
            .upsert({ 
              user_id: data.user.id, 
              role, 
              email 
            }, { 
              onConflict: 'user_id' 
            })
          
          if (profileError) {
            console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', profileError)
          }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª
        if (data.session) {
          // ã™ãã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹å ´åˆï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªä¸è¦ã®è¨­å®šï¼‰
          const { data: userRow } = await supabase
            .from('user_profiles')
            .select('role')
            .eq('user_id', data.user.id)
            .maybeSingle()
          
          const userRole = userRow?.role || role
          showSignedIn(data.user.email, userRole)
          showStatus('âœ… ç™»éŒ²å®Œäº†ï¼†è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ')
        } else {
          // ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªå ´åˆ
          showStatus('âœ… ç™»éŒ²å®Œäº†ï¼\n\nğŸ“§ ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\nãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦èªè¨¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚\n\nèªè¨¼å¾Œã€è‡ªå‹•çš„ã«ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚')
        }
        
      } catch (e) {
        console.error('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', e)
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + (e.message || e))
      } finally {
        btnSignup.disabled = false
      }
    })

    // ã‚µã‚¤ãƒ³ã‚¤ãƒ³
    btnSignin.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      const password = passwordInput.value
      
      if (!email || password.length < 8) {
        showStatus('âŒ ãƒ¡ãƒ¼ãƒ«ã¨8æ–‡å­—ä»¥ä¸Šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        return
      }
      
      btnSignin.disabled = true
      showStatus('ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³ä¸­...')
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password })
        if (error) throw error
        
        const userId = data.user.id
        
        // user_profilesã‹ã‚‰å½¹å‰²ã‚’å–å¾—
        const { data: userRow } = await supabase
          .from('user_profiles')
          .select('role')
          .eq('user_id', userId)
          .maybeSingle()
        
        const role = userRow?.role || 'student'
        showSignedIn(data.user.email, role)
        
      } catch (e) {
        console.error('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', e)
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + (e.message || e))
      } finally {
        btnSignin.disabled = false
      }
    })

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
    btnReset.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      if (!email) {
        showStatus('âŒ ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        return
      }
      
      btnReset.disabled = true
      showStatus('ğŸ“§ ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...')
      
      try {
        const redirectUrl = getRedirectUrl()
        const { error } = await supabase.auth.resetPasswordForEmail(email, { 
          redirectTo: redirectUrl
        })
        if (error) throw error
        showStatus('âœ… ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚')
      } catch (e) {
        console.error('ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', e)
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + (e.message || e))
      } finally {
        btnReset.disabled = false
      }
    })

    // ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
    btnSignout.addEventListener('click', async () => {
      try {
        await supabase.auth.signOut()
        afterEl.classList.add('hidden')
        showStatus('ğŸ‘‹ ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚')
      } catch (e) {
        console.error('ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', e)
        showStatus('âŒ ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼')
      }
    })

    // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—å›é¿ç‰ˆï¼‰
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('ğŸ”„ èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆ:', event, session ? 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ã‚Š' : 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡ã—')
      
      // refreshSession() ã‚’å‘¼ã°ãšã«ã€ç›´æ¥UIã‚’æ›´æ–°
      if (event === 'SIGNED_IN' && session) {
        updateUIFromSession(session)
      } else if (event === 'SIGNED_OUT') {
        afterEl.classList.add('hidden')
        showStatus('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚')
      }
    })

    // åˆæœŸåŒ–
    (async () => {
      console.log('ğŸš€ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹')
      await refreshSession()
      console.log('âœ… åˆæœŸåŒ–å®Œäº†')
    })()
  </script>
</body>
</html>
